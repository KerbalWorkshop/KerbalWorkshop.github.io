<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messier Gallery – Hansen Space</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
        .gallery-wrapper { background-color: var(--color-dark-grey-panel-bg); border-radius: 12px; padding: 30px; margin-bottom: 60px; border: 1px solid var(--color-light-grey-borders-dividers); }
        .messier-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: clamp(10px, 2vw, 20px); }
        .grid-item { position: relative; aspect-ratio: 1/1; background-color: var(--color-dark-grey-header-footer-bg); border: 1px solid var(--color-light-grey-borders-dividers); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-family: var(--font-headings); font-weight: 600; font-size: 1.2rem; color: var(--color-text-secondary); cursor: pointer; overflow: hidden; transition: transform .3s ease, box-shadow .3s ease; }
        .grid-item:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,.3); }
        .grid-item.photographed { background-size: cover; background-position: center; color: transparent; }
        .grid-item.photographed::before { content: attr(data-label); position: absolute; bottom: 0; left: 0; right: 0; padding: 15px 8px 8px; text-align: center; color: white; font-size: 0.9rem; background: linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.8)); opacity:0; transition: opacity .3s ease; }
        .grid-item.photographed:hover::before { opacity:1; }
        
        /* Modal and New Highlighter CSS */
        #gallery-modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:2200;}
        #gallery-modal.active{display:flex;}
        .gallery-modal-content{background:var(--color-dark-grey-panel-bg);color:var(--color-text-primary);border-radius:10px;max-width:90%;max-height:90vh;width:800px;overflow:hidden;display:flex;flex-direction:column;border:1px solid var(--color-light-grey-borders-dividers);box-shadow:0 5px 25px rgba(0,0,0,.5);}
        .gallery-modal-header{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:var(--color-dark-grey-header-footer-bg);border-bottom:1px solid var(--color-light-grey-borders-dividers);}
        .gallery-modal-title{font-family:var(--font-headings);font-weight:600;font-size:1.3rem;color:var(--color-text-headings);}
        .gallery-modal-close{font-size:1.8rem;font-weight:bold;cursor:pointer;color:var(--color-text-secondary);transition:color .2s ease;}
        .gallery-modal-close:hover{color:var(--color-text-accent);}
        .gallery-modal-body{padding:20px;text-align:center;overflow-y:auto;flex-grow:1;}
        .modal-image-container { position: relative; display: inline-block; line-height: 0; }
        .modal-image-container img{max-width:100%;height:auto;max-height:calc(85vh - 280px);border-radius:8px;display:block;margin:0 auto;}
        #bbox-highlighter-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        #bbox-highlighter-svg.visible { opacity: 0.9; }
        #bbox-highlighter-svg ellipse { fill: none; stroke: var(--color-text-accent); stroke-width: 2px; filter: drop-shadow(0 0 8px var(--color-text-accent)); }
        .modal-image-details{margin-top:15px;padding-top:15px;border-top:1px solid var(--color-light-grey-borders-dividers);text-align:left;}
        .subject-pills-container { padding-bottom: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--color-light-grey-borders-dividers); display: flex; flex-wrap: wrap; gap: 10px; }
        .subject-pill { background-color: var(--color-dark-grey-header-footer-bg); padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; }
        .subject-pill:hover { background-color: var(--color-accent-primary); color: var(--color-text-on-light); }
        p.detail-item{margin:0!important;padding:5px 0;font-size:.95rem;}
        p.detail-item strong{color:var(--color-text-headings);font-weight:600;margin-right:8px;}
    </style>
</head>
<body>
    <header><div class="header-inner-container content-limiter"><a class="brand" href="/index.html"><img src="/images/logo.png" alt="Hansen Space Logo"></a><nav><ul><li><a href="/index.html">Home</a></li><li><a href="/myjourney.html">My Journey</a></li><li><a href="/photography.html" class="active">Photography</a></li><li><a href="/articles">Articles</a></li><li><a href="/tools.html">Tools</a></li><li><a href="/contact.html">Contact</a></li></ul></nav><div class="menu-icon" onclick="toggleModal()">☰</div></div></header>
    <div class="modal-backdrop" id="modal-backdrop"></div><div class="modal" id="modal"><a href="/index.html">Home</a><a href="/myjourney.html">My Journey</a><a href="/photography.html" class="active">Photography</a><a href="/articles">Articles</a><a href="/tools.html">Tools</a><a href="/contact.html">Contact</a></div>

    <main class="page-main-content-area content-limiter">
        <div class="intro-block"><h1 class="intro-block__title">MESSIER GALLERY</h1><p class="intro-block__text">The Messier catalogue contains 110 celestial objects. This is my progress cataloging them all.</p></div>
        <div class="gallery-wrapper"><div class="messier-grid" id="messier-grid"><p>Loading Messier catalog...</p></div></div>
    </main>

    <div id="gallery-modal"><div class="gallery-modal-content"><div class="gallery-modal-header"><div class="gallery-modal-title" id="modal-title"></div><span class="gallery-modal-close" id="modal-close-button">×</span></div><div class="gallery-modal-body" id="modal-body"></div></div></div>

    <footer><div class="footer-inner-container content-limiter"><div class="social-links"><a href="https://www.youtube.com/hansenspace" target="_blank"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube"></a><a href="https://instagram.com/hansenspace" target="_blank"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram"></a><a href="https://tiktok.com/@hansen_space" target="_blank"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok"></a></div><p>© <span id="year">2025</span> Hansen Space.</p></div></footer>
    
    <script src="/scripts.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('messier-grid');
        const modal = document.getElementById('gallery-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseButton = document.getElementById('modal-close-button');
        let clickTimeoutId = null;
        let scrollY = 0;

        function openModal(shot) {
            if (!shot) return;
            modalTitle.textContent = shot.subject.name;
            let pillsHtml = '<div class="subject-pills-container">';
            shot.image.subjects.forEach(sub => { pillsHtml += `<span class="subject-pill" data-bbox="${sub.bounding_box}" data-name="${sub.name}">${sub.name}</span>`; });
            pillsHtml += '</div>';
            let detailsHtml = '';
            const details = [ { label: 'Date', value: shot.image.data.date }, { label: 'Camera', value: shot.image.data.camera }, { label: 'Telescope', value: shot.image.data.telescope }, { label: 'Integration', value: shot.image.data.integration, unit: ' min' }, { label: 'Notes', value: shot.image.data.notes, full: true } ];
            details.forEach(d => { if (d.value && d.value !== 'None' && d.value !== 'null') { const val = d.unit ? d.value + d.unit : d.value; detailsHtml += `<p class="detail-item ${d.full ? 'detail-item-full' : ''}"><strong>${d.label}:</strong> ${val}</p>`; } });
            
            modalBody.innerHTML = `
                <div class="modal-image-container">
                    <img id="modal-main-image" src="/${shot.image.image_file}" alt="${shot.image.label}" data-original-width="${shot.image.width}" data-original-height="${shot.image.height}">
                    <svg id="bbox-highlighter-svg"><ellipse/></svg>
                </div>
                <div class="modal-image-details">${pillsHtml}${detailsHtml}</div>
            `;
            
            const highlighter = document.getElementById('bbox-highlighter-svg');
            const modalImage = document.getElementById('modal-main-image');
            
            modalImage.onload = () => {
                document.querySelectorAll('.subject-pill').forEach(pill => {
                    const bbox = pill.dataset.bbox;
                    if (bbox && bbox !== 'null') {
                        pill.addEventListener('mouseenter', () => showHighlighter(bbox, modalImage, highlighter));
                        pill.addEventListener('mouseleave', () => hideHighlighter(highlighter));
                        pill.addEventListener('click', () => clickHighlighter(bbox, modalImage, highlighter));
                    } else { pill.style.cursor = 'default'; pill.style.opacity = '0.6'; }
                });
            };
            
            scrollY = window.scrollY;
            document.body.style.position = 'fixed';
            document.body.style.top = `-${scrollY}px`;
            document.body.style.width = '100%';
            modal.style.display = 'flex';
        }

        function closeModal() {
            modal.style.display = 'none';
            document.body.style.position = ''; document.body.style.top = ''; document.body.style.width = '';
            window.scrollTo(0, scrollY);
        }

        function showHighlighter(bbox, modalImage, svg) {
            const origW = parseInt(modalImage.dataset.originalWidth, 10);
            if (isNaN(origW) || !origW) return;

            const rect = modalImage.getBoundingClientRect();
            const scale = rect.width / origW;
            const coords = bbox.split(',').map(Number);
            if (coords.length < 8) return;

            const p1 = {x: coords[0], y: coords[1]}, p2 = {x: coords[2], y: coords[3]};
            const width = Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2)) * scale;
            const height = Math.sqrt(Math.pow(coords[6] - p1.x, 2) + Math.pow(coords[7] - p1.y, 2)) * scale;
            const angle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * (180 / Math.PI);
            const centerX = (p1.x + coords[4]) / 2 * scale;
            const centerY = (p1.y + coords[5]) / 2 * scale;
            
            const ellipse = svg.querySelector('ellipse');
            ellipse.setAttribute('cx', centerX);
            ellipse.setAttribute('cy', centerY);
            ellipse.setAttribute('rx', width / 2);
            ellipse.setAttribute('ry', height / 2);
            ellipse.setAttribute('transform', `rotate(${angle}, ${centerX}, ${centerY})`);
            
            svg.classList.add('visible');
        }

        function hideHighlighter(svg) { if (svg.dataset.clickVisible !== 'true') svg.classList.remove('visible'); }
        function clickHighlighter(bbox, modalImage, svg) {
            clearTimeout(clickTimeoutId);
            svg.dataset.clickVisible = 'true';
            showHighlighter(bbox, modalImage, svg);
            clickTimeoutId = setTimeout(() => { svg.dataset.clickVisible = 'false'; hideHighlighter(svg); }, 3000);
        }
        
        const renderPlaceholderGrid = (g) => {
            g.innerHTML = '';
            for (let i = 1; i <= 110; i++) { const d = document.createElement('div'); d.className = 'grid-item'; d.textContent = `M${i}`; g.appendChild(d); }
        };

        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        modalCloseButton.addEventListener('click', closeModal);
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

        try {
            const v = Date.now();
            const [galleriesRes, imagesRes] = await Promise.all([fetch(`/photos/data/galleries.json?v=${v}`), fetch(`/photos/data/all_images.json?v=${v}`)]);
            if (!galleriesRes.ok || !imagesRes.ok) throw new Error('Failed to load gallery data files.');
            const galleriesMap = await galleriesRes.json();
            const allImages = await imagesRes.json();
            const messierId = galleriesMap['Messier'];
            if (typeof messierId === 'undefined') throw new Error('"Messier" gallery not found in galleries.json.');
            const messierImages = allImages.filter(img => img.gallery_ids.includes(messierId));
            const bestMessierShots = {};
            const messierNumRegex = /M(\d+)/;
            messierImages.forEach(image => {
                image.subjects.forEach(subject => {
                    const match = subject.name.match(messierNumRegex);
                    if (match && subject.thumb_path) {
                        const num = parseInt(match[1], 10);
                        const existing = bestMessierShots[num];
                        if (!image.data.date) return;
                        const currentDate = new Date(image.data.date);
                        if (!existing || currentDate > new Date(existing.image.data.date)) {
                            bestMessierShots[num] = { image: image, subject: subject };
                        }
                    }
                });
            });
            grid.innerHTML = '';
            for (let i = 1; i <= 110; i++) {
                const div = document.createElement('div');
                div.className = 'grid-item';
                const shot = bestMessierShots[i];
                if (shot) {
                    div.classList.add('photographed');
                    div.style.backgroundImage = `url('/${shot.subject.thumb_path}')`;
                    div.dataset.label = shot.subject.name;
                    div.addEventListener('click', () => openModal(shot));
                } else {
                    div.textContent = `M${i}`;
                }
                grid.appendChild(div);
            }
        } catch (e) {
            console.error('Error loading Messier gallery:', e);
            renderPlaceholderGrid(grid);
        }
    });
    </script>
</body>
</html>