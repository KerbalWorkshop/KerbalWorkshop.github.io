<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Planets Dashboard – Hansen Space</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Nunito+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css"> <style>
  :root {
    --canvas:1200px;    /* grey strip max width */
    --side-pad:80px;    /* gutters */
    --grey:#2e2e2e;     /* strip bg */
    --cell:200px;       /* size grid cell */
    --gap:50px;         /* grid gap */
    --dist-aspect:1000/256; /* native distance chart ratio */
  }
  * { box-sizing:border-box; margin:0 }
  body {
    font-family:'Nunito Sans',sans-serif;
    background:#fff; color:#eee;
    overflow-x:hidden;
  }
  a { color:inherit; text-decoration:none }

  /* ----- header ----- */
  header {
    display:flex; justify-content:space-between; align-items:center;
    padding:18px var(--side-pad); background:#fff; color:#111;
  }
  header nav ul {
    display:flex; gap:30px; list-style:none;
    font-weight:600; font-size:16px;
  }
  header .active { border-bottom:2px solid #111; padding-bottom:3px }
  .menu-icon { display:none; font-size:1.4rem }
  @media(max-width:850px) {
    header nav { display:none }
    .menu-icon { display:block; cursor:pointer }
  }

  /* ----- grey strip ----- */
  #content { background:var(--grey); padding:0 var(--side-pad) }
  #inner   { max-width:var(--canvas); margin:0 auto; padding:30px 0 }

  /* intro */
  .intro-section {
    display:flex; justify-content:space-between; align-items:center;
    gap:40px; margin-bottom:60px;
  }
  .intro-title { font:700 40px/1 'Poppins'; color:#fff }
  .intro-text {
    max-width:640px; font-size:18px; line-height:1.6; color:#d0d0d0;
  }
  @media(max-width:850px) {
    .intro-section { flex-direction:column; text-align:center }
  }

  /* shared */
  .dash-block  { margin-bottom:70px }
  .block-title { font:600 28px/1 'Poppins'; margin-bottom:24px; color:#fff }
  .pill-switch {
    display:flex; background:#555; border-radius:40px;
    overflow:hidden; width:max-content; margin:0 auto 40px;
    font-size:14px;
  }
  .pill-switch button {
    padding:10px 18px; border:none; background:transparent;
    color:#eee; font-weight:600; cursor:pointer;
  }
  .pill-switch button.active {
    background:#fff; color:#000;
  }
  .pill-switch button:disabled {
    color: #888; cursor: not-allowed;
  }

  /* panels */
  .panel {
    background:#000; border-radius:6px;
    padding:48px 20px; margin-bottom:50px;
  }

  /* SIZE grid */
  #size-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(var(--cell),1fr));
    grid-auto-rows:var(--cell);
    gap:var(--gap);
    justify-content:center;
    min-height: 100px; /* Ensure space for loading/error message */
  }
  .planet-slot {
    position:relative; display:flex; flex-direction: column;
    justify-content:center; align-items:center;
  }
  .planet-image-container { /* Added container */
    flex-grow: 1; display: flex; justify-content: center; align-items: center;
    width: 100%; /* Ensure container takes space */
  }
  .size-label {
    position:absolute; bottom:-26px; left:50%;
    transform:translateX(-50%);
    font-size:14px; color:#eee; white-space:nowrap;
  }

  /* DISTANCE */
  .panel-distance { padding-top:48px; padding-bottom:48px }
  #dist-box {
    width:80%; max-width:var(--canvas);
    margin:0 auto;
    aspect-ratio: var(--dist-aspect);
    position:relative;
     min-height: 150px; /* Ensure space for loading/error message */
  }
  .dist-track {
    position:absolute; top:0; left:0;
    width:100%; height:100%;
  }
  .dist-track::before {
    content:""; position:absolute; top:50%; left:0;
    width:100%; height:2px; background:#666;
    transform:translateY(-50%);
  }
  .anchor {
    position:absolute; left:0; top:50%;
    transform:translate(-50%,-50%);
  }
  #dist-planets img { /* Target images specifically within #dist-planets */
    position:absolute; /* Keep positioning */
    /* transform handled inline */
    /* height/width handled inline */
    max-width: 100px; /* Add max-width for safety */
  }
  .dist-label {
    position:absolute;
    top:calc(50% - 40px);
    color:#ddd;
    white-space:nowrap;
    transform-origin:top left;
    transform:rotate(-40deg);
    /* Using clamp for responsive font size */
    font-size: clamp(10px, 1.2vw, 14px);
  }

  /* divider */
  .div { height:1px; background:#555; margin:50px 0 }

  /* footer */
  footer {
    padding:20px var(--side-pad);
    background:#fff; text-align:center;
    font-size:14px; color:#999;
  }
  footer .social-links { margin-bottom:12px }
  footer .social-links img {
    height:24px; margin:0 10px;
  }

  /* mobile tweaks */
  @media(max-width:850px) {
    :root { --side-pad:20px }
    body { font-size:90% } /* Base scaling */

    /* Apply uniform scaling to key text elements */
    .intro-title { font-size: 26px; }
    .intro-text  { font-size: 14px; }
    .block-title { font-size: 22px; }
    .pill-switch { font-size: 12px; }

    .size-label,.dist-label { font-size:12px } /* Override clamp if needed on small screens */
    header nav ul { font-size:14px }
    :root {
      --cell:  calc(200px*0.7);
      --gap:   calc(50px *0.7);
    }
  }
  </style>
</head>
<body>

  <header>
    <a class="brand" href="/"><img src="/images/logo.png" alt="Hansen Space"></a>
    <nav><ul>
      <li><a href="/">Home</a></li>
      <li><a href="/myjourney.html">My Journey</a></li>
      <li><a href="/photography.html">Photography</a></li>
      <li><a href="/articles">Articles</a></li>
      <li><a href="/tools.html" class="active">Tools</a></li>
      <li><a href="/contact.html">Contact</a></li>
    </ul></nav>
    <div class="menu-icon" onclick="toggleModal()">☰</div>
  </header>

  <div id="content">
    <div id="inner">

      <div class="intro-section">
        <h2 class="intro-title">PLANET DASHBOARD</h2>
        <p class="intro-text">A planetary dashboard for all of your needs.</p>
      </div>

      <section class="dash-block">
        <h3 class="block-title">SIZE</h3>
        <div class="pill-switch" id="size-mode">
          <button data-mode="true">true size</button>
          <button data-mode="apparent-earth" class="active">apparent size (Earth)</button>
          <button data-mode="apparent-sun">apparent size (Sun)</button>
        </div>
        <div class="panel">
          <div id="size-grid">
              </div>
        </div>
      </section>

      <section class="dash-block">
        <h3 class="block-title">DISTANCE</h3>
        <div class="pill-switch" id="dist-mode">
          <button data-mode="sun">from Sun</button>
          <button data-mode="earth" class="active">from Earth</button>
          <button disabled>placeholder</button>
        </div>
        <div class="panel panel-distance">
          <div id="dist-box">
            <div class="dist-track">
              </div>
          </div>
        </div>
      </section>

      <div class="div"></div>

      <section class="dash-block">
        <h3 class="block-title">IN THE SKY (coming soon)</h3>
        <p style="color:#ccc">Feature under construction.</p>
      </section>

    </div>
  </div>

  <footer>
    <div class="social-links">
      <a href="https://www.youtube.com/hansenspace"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube"></a>
      <a href="https://instagram.com/hansenspace"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram"></a>
      <a href="https://tiktok.com/@hansen_space"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok"></a>
    </div>
    <p>© 2025 Hansen Space.</p>
  </footer>

 <script>
   console.log("[Client Script] Initializing script execution.");

   // --- Static Fallback Data ---
   const META={mercury:4879,venus:12104,earth:12756,mars:6779,jupiter:139820,
               saturn:116460,uranus:50724,neptune:49244};
   console.log("[Client Script] Static META (diameters km):", META);
   const SMA ={mercury:.387,venus:.723,earth:1,mars:1.524,
               jupiter:5.203,saturn:9.537,uranus:19.191,neptune:30.068};
   console.log("[Client Script] Static SMA (semi-major axis AU):", SMA);
   const RF  ={saturn:1206/2737}; // Ring factor for Saturn image width
   const ORDER=["mercury","venus","mars","jupiter","saturn","uranus","neptune","earth"];
   const AU  =149597870.7; // km per AU
   console.log("[Client Script] ORDER:", ORDER, "AU:", AU);

   // --- State Variables ---
   let livePlanetData = null; // Will hold data from API
   let dataFetchError = null; // Store fetch error
   let sizeMode="apparent-earth", distMode="earth";
   console.log("[Client Script] Initial modes - sizeMode:", sizeMode, "distMode:", distMode);

   // --- Helper: Combine static and live data ---
   function getPlanetData(planetId) {
       console.log(`[getPlanetData] Requesting data for: ${planetId}`);
       const staticData = {
           id: planetId,
           d: META[planetId], // Diameter (km)
           sma_sun: SMA[planetId], // Semi-major axis from Sun (AU) - fallback
           sma_earth: Math.abs(SMA[planetId] - 1) || 0.3, // Approx distance from Earth (AU) - fallback
       };

       if (livePlanetData && livePlanetData[planetId]) {
           const live = livePlanetData[planetId];
           console.log(`[getPlanetData] Found live data for ${planetId}:`, live);
           // Prefer live data if available, fall back to SMA for distances
           const result = {
               ...staticData,
               // Use optional chaining and nullish coalescing for safety
               dist_sun: live.distance?.fromSun?.au ?? staticData.sma_sun,
               dist_earth: live.distance?.fromObserver?.au ?? staticData.sma_earth,
           };
           console.log(`[getPlanetData] Combined data for ${planetId} (using live):`, result);
           return result;
       } else {
            // If no live data, return static data using SMA as current distance (less accurate)
            const result = {
                ...staticData,
                dist_sun: staticData.sma_sun,
                dist_earth: staticData.sma_earth,
            };
           console.warn(`[getPlanetData] No live data for ${planetId}. Using static fallback:`, result);
           return result;
       }
   }

   // --- Build Initial HTML Structure ---
   const gridElement = document.getElementById('size-grid');
   console.log("[Client Build] Building initial size grid structure.");
   ORDER.forEach(p=>{
     let slot=document.createElement('div');
     slot.className='planet-slot'; slot.id=`slot-${p}`;
     slot.innerHTML=`<div class="planet-image-container"></div><div id="lbl-${p}" class="size-label">Loading...</div>`;
     gridElement.append(slot);
   });

   const distBoxElement = document.getElementById('dist-box');
   const distTrackElement = distBoxElement?.querySelector('.dist-track');
   if (distTrackElement && !document.getElementById('dist-anchor')) {
       console.log("[Client Build] Adding distance anchor element.");
       distTrackElement.insertAdjacentHTML('afterbegin',
           '<img id="dist-anchor" class="anchor" src="/planets/earth.png" alt="anchor">' // Default to earth
       );
   }
   if (distTrackElement && !document.getElementById('dist-planets')) {
       console.log("[Client Build] Adding distance planets container element.");
       distTrackElement.insertAdjacentHTML('beforeend', '<div id="dist-planets"></div>');
   }


   // --- Calculate Angular Size ---
   function calculateAngularSize(planetId, perspective) { // perspective is 'earth' or 'sun'
       console.log(`[Angular Size Calc] Calculating for ${planetId} from ${perspective}`);
       const pData = getPlanetData(planetId);
       if (!pData) {
           console.error(`[Angular Size Calc] No data found for ${planetId}`);
           return 0;
       }

       const radiusKm = pData.d / 2;
       const distanceAu = (perspective === 'earth') ? pData.dist_earth : pData.dist_sun;
       const distanceKm = distanceAu * AU;
       console.log(`[Angular Size Calc] ${planetId}: Radius=${radiusKm}km, Dist=${distanceAu}AU (${distanceKm}km)`);

       if (distanceKm <= 0) {
            console.warn(`[Angular Size Calc] Invalid distance (${distanceKm}km) for ${planetId}, returning 0 angular size.`);
            return 0;
       }

       const angleRad = 2 * Math.atan(radiusKm / distanceKm); // Result in radians
       console.log(`[Angular Size Calc] ${planetId} from ${perspective}: ${angleRad} radians`);
       return angleRad;
   }

   // --- Draw SIZE Grid ---
   function drawSize(){
     console.log(`[Draw Size] Starting draw. Mode: ${sizeMode}. Has live data: ${!!livePlanetData}. Error: ${dataFetchError}`);
     const grid = document.getElementById('size-grid');
     if (!grid) {
         console.error("[Draw Size] Cannot find #size-grid element!");
         return;
     }

     if (dataFetchError) {
         console.error("[Draw Size] Rendering fetch error message:", dataFetchError);
         grid.innerHTML = `<p style="color:red; text-align:center; grid-column: 1 / -1;">Error loading planet data: ${dataFetchError}</p>`;
         return;
     }
     if (!livePlanetData && !dataFetchError) {
        console.log("[Draw Size] Waiting for data, showing 'Loading...' labels.");
        // Ensure loading labels are present (redundant if build worked, safe otherwise)
        ORDER.forEach(p => {
            const lbl = document.getElementById(`lbl-${p}`);
            if (lbl && !lbl.textContent.includes('Loading')) lbl.textContent = 'Loading...';
        });
        return;
     }

     console.log("[Draw Size] Proceeding with rendering planets.");
     // Calculate max potential angular size across all planets from both perspectives using current data
     const peakArc = Math.max(...ORDER.map(p => {
         const arcEarth = (p === 'earth') ? 0 : calculateAngularSize(p, 'earth');
         const arcSun = calculateAngularSize(p, 'sun');
         return Math.max(arcEarth, arcSun);
     }));
     console.log(`[Draw Size] Calculated peak angular size (radians) for scaling: ${peakArc}`);

     let maxDisc = 200 * 0.78; // Base max diameter in pixels
     if (window.innerWidth < 850) maxDisc *= 0.7; // Adjust for mobile
     console.log(`[Draw Size] Max disc size for rendering: ${maxDisc}px`);

     ORDER.forEach(p => {
       console.log(`[Draw Size] Processing planet: ${p}`);
       let slot = document.getElementById(`slot-${p}`);
       let lbl = document.getElementById(`lbl-${p}`);
       let imgContainer = slot?.querySelector('.planet-image-container');

       if(!slot || !lbl || !imgContainer) {
           console.error(`[Draw Size] Missing elements for planet ${p} (slot, label, or img container). Skipping.`);
           return;
       }

       const pData = getPlanetData(p); // Reuse helper

       // Hide Earth slot if viewing apparent size from Earth
       if (p === 'earth' && sizeMode === 'apparent-earth') {
         console.log(`[Draw Size] Hiding Earth slot for mode ${sizeMode}.`);
         slot.style.visibility = 'hidden';
         lbl.textContent = '';
         imgContainer.innerHTML = ''; // Clear image
         return;
       }
       slot.style.visibility = 'visible';

       let metric, ref, unitLabel;
       if (sizeMode === 'true') {
           metric = pData.d; // Diameter in km
           ref = Math.max(...ORDER.map(q => getPlanetData(q).d)); // Max diameter among all planets
           unitLabel = `${(pData.d / 2).toLocaleString()} km`; // Radius
           console.log(`[Draw Size] ${p} (True Size): Metric=${metric}km, Ref=${ref}km, Label=${unitLabel}`);
       } else { // Apparent size modes
           const perspective = (sizeMode === 'apparent-earth') ? 'earth' : 'sun';
           metric = calculateAngularSize(p, perspective); // Angular size in radians
           ref = peakArc; // Use pre-calculated max angular size
           unitLabel = `${(metric * 206264.806).toFixed(1)}″`; // Convert radians to arcseconds
           console.log(`[Draw Size] ${p} (Apparent Size from ${perspective}): Metric=${metric}rad, Ref=${ref}rad, Label=${unitLabel}`);
       }

       // Calculate pixel size, ensuring a minimum size for visibility
       const px = Math.max(4, (metric / ref) * maxDisc);
       console.log(`[Draw Size] ${p}: Calculated pixel size: ${px}px`);

       // Update image - *** VERIFY THIS PATH: /planets/ ***
       const imagePath = `/planets/${p}.png`;
       imgContainer.innerHTML = `<img src="${imagePath}" alt="${p}"
         style="${p === 'saturn' ? 'height:' + px + 'px;width:auto' : 'width:' + px + 'px;height:' + px + 'px'}">`;

       lbl.textContent = unitLabel;
       console.log(`[Draw Size] Updated slot for ${p}.`);
     });
     console.log("[Draw Size] Finished drawing all planets.");
   }

   // --- Draw DISTANCE Chart ---
   function drawDist(){
     console.log(`[Draw Distance] Starting draw. Mode: ${distMode}. Has live data: ${!!livePlanetData}. Error: ${dataFetchError}`);
     const distBox = document.getElementById('dist-box');
      if (!distBox) {
         console.error("[Draw Distance] Cannot find #dist-box element!");
         return;
     }

     if (dataFetchError) {
         console.error("[Draw Distance] Rendering fetch error message:", dataFetchError);
         // Clear the box and show error
         distBox.innerHTML = `<p style="color:red; text-align:center;">Error loading planet data: ${dataFetchError}</p>`;
         return;
     }

     let anchor = document.getElementById('dist-anchor');
     let track = document.getElementById('dist-planets');

     if (!anchor || !track) {
         // Might happen if data hasn't loaded yet and elements weren't created, or if error occurred
         if (!livePlanetData && !dataFetchError) {
             console.log("[Draw Distance] Waiting for data, showing 'Loading...' message in track.");
             if(distBox.querySelector('.dist-track') && !distBox.querySelector('#dist-planets')) {
                 // If track exists but planets div doesn't, add it.
                 distBox.querySelector('.dist-track').insertAdjacentHTML('beforeend', '<div id="dist-planets"><p style="color:#ccc; text-align:center; padding-top: 20px;">Loading distances...</p></div>');
             } else if (track) {
                 track.innerHTML = '<p style="color:#ccc; text-align:center; padding-top: 20px;">Loading distances...</p>';
             } else {
                 // Fallback if track itself is missing
                 distBox.innerHTML = '<p style="color:#ccc; text-align:center;">Loading distances...</p>';
             }
         } else {
             console.error("[Draw Distance] Cannot find #dist-anchor or #dist-planets elements!");
         }
         return; // Exit drawDist if elements aren't ready or error hasn't cleared them
     }


     console.log("[Draw Distance] Proceeding with rendering distance chart.");
     // Set anchor image and size - *** VERIFY THESE PATHS: /planets/ ***
     const anchorImagePath = (distMode === 'sun' ? '/planets/sun.png' : '/planets/earth.png');
     anchor.src = anchorImagePath;
     anchor.style.height = (distMode === 'sun' ? '43.75%' : '15.625%');
     console.log(`[Draw Distance] Set anchor to ${anchorImagePath}, height ${anchor.style.height}`);

     // Determine the set of planets and max distance
     let set = (distMode === 'sun') ? ORDER : ORDER.filter(p => p !== 'earth');
     let maxAU = 0;
     try {
         maxAU = Math.max(...set.map(p => {
             const pData = getPlanetData(p); // Use helper
             return (distMode === 'sun') ? pData.dist_sun : pData.dist_earth;
         }));
     } catch (e) {
         console.error("[Draw Distance] Error calculating maxAU. Likely issue fetching/processing data.", e);
         track.innerHTML = `<p style="color:red; text-align:center;">Error processing distances.</p>`;
         return;
     }

     console.log(`[Draw Distance] Planet set for mode ${distMode}: ${set.join(', ')}. Max distance: ${maxAU} AU.`);

     track.innerHTML = ''; // Clear previous planets/labels

     set.forEach((p, i) => {
       console.log(`[Draw Distance] Processing planet: ${p}`);
       const pData = getPlanetData(p); // Use helper
       const au = (distMode === 'sun') ? pData.dist_sun : pData.dist_earth;

        if (typeof au !== 'number' || isNaN(au)) {
            console.error(`[Draw Distance] Invalid distance value (${au}) for ${p}. Skipping.`);
            return; // Skip this planet if distance is invalid
        }

       const pct = (maxAU > 0) ? (au / maxAU) * 100 : 0; // Position percentage along the track, handle maxAU=0 case
       console.log(`[Draw Distance] ${p}: Distance=${au}AU, Position=${pct}%`);

       // Calculate visual size relative to Jupiter (like original code)
       const relativeDiameter = pData.d / META.jupiter;
       const ringAdjust = (p === 'saturn' ? RF.saturn : 1);
       const visualHeightPct = relativeDiameter * ringAdjust * 43.75; // Height as % of container
       console.log(`[Draw Distance] ${p}: Visual height=${visualHeightPct}%`);

       // Nudge inner planets labels slightly for readability when 'from Sun'
       const nudge = (i < 4 && distMode === 'sun') ? -20 : 0; // Adjust nudge px value if needed
       console.log(`[Draw Distance] ${p}: Label nudge=${nudge}px`);

       // Add planet image - *** VERIFY PATH: /planets/ ***
       const planetImagePath = `/planets/${p}.png`;
       track.insertAdjacentHTML('beforeend',
         `<img src="${planetImagePath}" alt="${p}"
             style="position:absolute; left:${pct}%; top:50%;
                    transform:translate(-50%,-50%);
                    height:${visualHeightPct}%; width:auto;
                    ">` // max-width removed, relies on height calculation
       );

       // Add distance label
       track.insertAdjacentHTML('beforeend',
         `<div class="dist-label" style="left:calc(${pct}% + ${nudge}px)">
           ${au.toFixed(3)} AU
          </div>`
       );
       console.log(`[Draw Distance] Added image and label for ${p}.`);
     });
     console.log("[Draw Distance] Finished drawing distance chart.");
   }

   // --- Button Handlers ---
   document.querySelectorAll('#size-mode button').forEach(b=>{
     b.onclick=()=>{
       console.log(`[Size Mode Button] Clicked: ${b.dataset.mode}. Active: ${b.classList.contains('active')}, Disabled: ${b.disabled}`);
       if(b.classList.contains('active') || b.disabled) return;
       sizeMode=b.dataset.mode;
       console.log(`[Size Mode Button] Setting sizeMode to: ${sizeMode}`);
       b.parentNode.querySelectorAll('button')
        .forEach(x=>x.classList.toggle('active',x===b));
       drawSize(); // Redraw with new mode
     };
   });
   document.querySelectorAll('#dist-mode button').forEach(b=>{
     b.onclick=()=>{
       console.log(`[Dist Mode Button] Clicked: ${b.dataset.mode}. Active: ${b.classList.contains('active')}, Disabled: ${b.disabled}`);
       if(b.classList.contains('active') || b.disabled) return;
       distMode=b.dataset.mode;
       console.log(`[Dist Mode Button] Setting distMode to: ${distMode}`);
       b.parentNode.querySelectorAll('button')
        .forEach(x=>x.classList.toggle('active',x===b));
       drawDist(); // Redraw with new mode
     };
   });

   // --- Fetch Data Function ---
   async function fetchPlanetData() {
       console.log("[Client Fetch] Starting fetchPlanetData function.");
       dataFetchError = null; // Reset error state
       livePlanetData = null; // Reset data state
       // Update UI to show loading state immediately
       drawSize(); // Will show "Loading..." labels
       drawDist(); // Will show "Loading..." message

       const apiUrl = '/.netlify/functions/planetDashboard';
       console.log(`[Client Fetch] Fetching from URL: ${apiUrl}`);
       try {
           const response = await fetch(apiUrl);
           console.log(`[Client Fetch] Received response. Status: ${response.status}, OK: ${response.ok}`);
           // Log headers (optional, can be verbose)
           // console.log("[Client Fetch] Response Headers:", Object.fromEntries(response.headers.entries()));

           if (!response.ok) {
               const errorText = await response.text(); // Get error body if possible
               console.error(`[Client Fetch] Fetch failed! Status: ${response.status}. Body: ${errorText}`);
               throw new Error(`API Error: ${response.status} ${response.statusText}. ${errorText}`);
           }

           const data = await response.json();
           console.log("[Client Fetch] Raw JSON data received:", JSON.stringify(data, null, 2)); // Pretty print JSON

           // Process data into the livePlanetData structure
           if (data && data.data && data.data.table && data.data.table.rows) {
               livePlanetData = {}; // Initialize as object
               data.data.table.rows.forEach(row => {
                   if (row.entry && row.entry.id && row.cells && row.cells.length > 0) {
                       const planetId = row.entry.id.toLowerCase(); // Use id field from API
                       // Ensure it's a planet we care about
                       if (ORDER.includes(planetId) || planetId === 'earth') {
                           livePlanetData[planetId] = row.cells[0]; // Store the first cell data object
                           console.log(`[Client Fetch] Processed data for ${planetId}:`, livePlanetData[planetId]);
                       } else {
                           console.log(`[Client Fetch] Skipping unknown entry ID: ${planetId}`);
                       }
                   } else {
                        console.warn("[Client Fetch] Skipping row due to missing id or cells:", row);
                   }
               });

                // Ensure Earth data exists, even if API didn't provide it (e.g., distance from self)
                if (!livePlanetData.earth) {
                    console.warn("[Client Fetch] API response missing 'earth', adding default entry.");
                    livePlanetData.earth = {
                        distance: { fromObserver: { au: 0 }, fromSun: { au: 1.0 } }, // Approx Sun dist
                        // Add other fields if needed, matching API structure expected by getPlanetData
                        position: { // Example placeholder if needed
                           equatorial: { rightAscension: { hours: 0 }, declination: { degrees: 0 }}
                        }
                    };
                }

               console.log("[Client Fetch] Final processed livePlanetData:", livePlanetData);
               dataFetchError = null; // Clear any previous error state on success
           } else {
               console.error("[Client Fetch] Unexpected API data structure received:", data);
               throw new Error("Unexpected API data structure");
           }

       } catch (error) {
           console.error("[Client Fetch] Error during fetch or processing:", error);
           dataFetchError = error.message || "Failed to load data"; // Store error message
           livePlanetData = null; // Ensure we don't use potentially corrupt/incomplete data
       } finally {
           // Data fetch attempt finished (success or error), trigger redraws
           console.log("[Client Fetch] Fetch attempt complete. Triggering final redraws.");
           drawSize();
           drawDist();
       }
   }

   // --- Initial Load ---
   console.log("[Client Script] Adding DOMContentLoaded listener.");
   document.addEventListener('DOMContentLoaded', () => {
        console.log("[Client Script] DOMContentLoaded event fired. Starting data fetch.");
        fetchPlanetData(); // Fetch data once the basic DOM is ready
   });


   // --- Resize Listener ---
    console.log("[Client Script] Adding resize listener.");
   let resizeTimeout;
   window.addEventListener('resize',()=>{
       console.log("[Client Resize] Resize event detected.");
       clearTimeout(resizeTimeout);
       resizeTimeout = setTimeout(() => {
            console.log("[Client Resize] Debounced resize - redrawing.");
            drawSize();
            drawDist();
       }, 250); // Debounce redraws on resize
   });

   // --- Menu Toggle Placeholder ---
   function toggleModal() {
       console.warn("[Client Script] toggleModal() called - function not implemented in this script.");
       // Assuming this is handled by global scripts.js or similar
   }

   console.log("[Client Script] End of script initialization.");

 </script>
 <script src="/scripts.js"></script> </body>
</html>