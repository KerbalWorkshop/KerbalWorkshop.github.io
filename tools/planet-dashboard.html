<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Planets Dashboard – Hansen Space</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    /* Dashboard-specific CSS variables */
    :root {
      --cell:200px;      
      --gap:50px;        
      --dist-aspect:1000/256; 
      --dist-planet-base-height-pct: 35%; 
      --dist-planet-min-height-pct: 0.1%;  
      --dist-planet-max-height-pct: 80%;  

      --obs-bar-height: 28px;
      --obs-bar-border-radius: 8px;
      --obs-bar-spacing: 18px;
      --obs-label-width: 100px;
    }

    .loading-overlay, .error-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(30,30,30,0.85); 
      display: flex; justify-content: center; align-items: center;
      text-align: center; z-index: 10; color: var(--color-text-primary);
      font-size: 16px; padding: 20px; pointer-events: none;
      border-radius: 8px; 
    }
    .error-overlay {
      color: var(--color-text-error);
      background: rgba(50,0,0,0.85); 
    }

    .dashboard-panel { 
      background: black; 
      border-radius:8px; 
      padding:30px 20px;
      position: relative;
      min-height: 150px;
      overflow: hidden;
    }

    #size-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(var(--cell),1fr));
      grid-auto-rows:var(--cell);
      gap:var(--gap);
      justify-content:center;
      padding-bottom: 30px; 
    }
    .planet-slot {
      position:relative; display:flex; flex-direction: column;
      justify-content:center; align-items:center;
    }
    .planet-image-container {
      flex-grow: 1; display: flex; justify-content: center; align-items: center;
      width: 100%; height: 100%; 
    }
    /* FIX: Unclamped width allows Saturn's rings to extend naturally */
    .planet-image-container img {
      max-width: none; 
      object-fit: contain;
    }
    .size-label {
      position:absolute; bottom:-26px; left:50%; transform:translateX(-50%);
      font-size:14px; color: var(--color-text-secondary); white-space:nowrap;
    }

    .panel-distance { 
        padding-top:30px; padding-bottom:30px
    }
    #dist-box {
      width:100%; max-width:none; margin:0 auto;
      aspect-ratio: var(--dist-aspect); position:relative; min-height: 150px;
      overflow: visible; 
    }
    .dist-track { position:absolute; top:0; left:0; width:100%; height:100%; }
    .dist-track::before { 
      content:""; position:absolute; top:50%;
      left: 5%; width: 90%; height:2px;
      background: var(--color-light-grey-borders-dividers); transform:translateY(-50%);
     }
    .anchor { 
      position:absolute; left:0; top:50%; z-index: 5; width: auto; max-height: none;
      /* Transform is handled in JS to switch between Sun (offset) and Planets (centered) */
     }
    #dist-planets { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      padding: 0; color: var(--color-text-secondary); font-size: 12px;
      line-height: 1.5; font-family: monospace; 
      overflow: visible;
    }
    #dist-planets .dist-planet-img {
      position:absolute; top:50%; transform:translate(-50%, -50%); width:auto;
      min-height: var(--dist-planet-min-height-pct); max-height: var(--dist-planet-max-height-pct);
      z-index: 4; object-fit: contain;
     }
    #dist-planets .dist-label {
      position:absolute; top:calc(50% - 40px); color: var(--color-text-primary); white-space:nowrap;
      transform-origin:top left; transform:rotate(-40deg);
      font-size: clamp(10px, 1.2vw, 14px); z-index: 6;
     }

    #observability-section {
        padding-top: 10px; padding-bottom: 10px;
    }
    #observability-content-area { 
        position: relative; 
        min-height: 100px; 
    }
    #observability-chart {
        padding: 10px 0; 
    }
    .observability-planet-row {
        display: flex;
        align-items: center;
        margin-bottom: var(--obs-bar-spacing);
    }
    .observability-planet-label {
        width: var(--obs-label-width);
        padding-right: 15px;
        text-align: right;
        font-size: 15px; 
        font-weight: 600; 
        color: var(--color-text-primary); 
        text-transform: capitalize;
        flex-shrink: 0; 
    }
    .observability-bar-container {
        flex-grow: 1;
        height: var(--obs-bar-height);
        position: relative; 
    }
    .observability-bar {
        width: 100%;
        height: 100%;
        border-radius: var(--obs-bar-border-radius);
        background: var(--color-light-grey-borders-dividers); 
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
        cursor: crosshair; 
    }
    #observability-tooltip {
        position: fixed; 
        background-color: rgba(10, 10, 10, 0.92); 
        color: var(--color-text-primary);
        border: 1px solid var(--color-light-grey-borders-dividers);
        padding: 8px 12px; 
        border-radius: 6px;
        font-size: 12px; 
        font-family: var(--font-primary); 
        line-height: 1.6; 
        white-space: nowrap;
        z-index: 10010; 
        pointer-events: none; 
        display: none; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    #observability-tooltip div { 
        margin-bottom: 2px; 
    }
     #observability-tooltip div:last-child {
        margin-bottom: 0;
    }
    
    @media (max-width: 850px) {
      :root { 
        --cell: calc(200px * 0.55); --gap: calc(50px * 0.6);
        --dist-planet-base-height-pct: 18%; --dist-planet-max-height-pct: 65%;
        --obs-label-width: 85px; --obs-bar-height: 26px;
      }
      .size-label { font-size:12px }
      #dist-planets .dist-label { font-size: clamp(9px, 1.3vw, 12px); top:calc(50% - 30px); }
      .observability-planet-label { font-size: 14px; }
      .dashboard-panel { padding: 20px 15px; }
      #size-grid { padding-bottom: 20px; }
    }
    @media (max-width: 480px) {
      :root { 
          --cell: calc(200px * 0.45); --gap: calc(50px * 0.5);
          --dist-planet-base-height-pct: 15%; --dist-planet-max-height-pct: 55%;
          --obs-label-width: auto; --obs-bar-height: 24px; --obs-bar-spacing: 16px;
      }
      .size-label { font-size:11px; bottom: -22px; }
      #dist-planets .dist-label { font-size: clamp(8px, 1.5vw, 10px); top:calc(50% - 25px); }
      .observability-planet-row { flex-direction: column; align-items: stretch; }
      .observability-planet-label { text-align: left; width: 100%; margin-bottom: 6px; padding-right: 0;}
      .observability-bar-container { width: 100%; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner-container content-limiter">
      <a class="brand" href="/index.html">
        <img src="/images/logo.png" alt="Hansen Space Logo" onerror="this.src='https://placehold.co/200x50/1c1c1c/FFFFFF?text=Hansen+Space'; this.onerror=null;" />
      </a>
      <nav>
        <ul>
          <li><a href="/index.html">Home</a></li>
          <li><a href="/myjourney.html">My Journey</a></li>
          <li><a href="/photography.html">Photography</a></li>
          <li><a href="/articles">Articles</a></li>
          <li><a href="/tools.html" class="active">Tools</a></li>
          <li><a href="/contact.html">Contact</a></li>
        </ul>
      </nav>
      <div class="menu-icon" onclick="toggleModal()">☰</div>
    </div>
  </header>

  <div class="modal-backdrop" id="modal-backdrop" onclick="toggleModal()"></div>
  <div class="modal" id="modal">
    <a href="/index.html">Home</a>
    <a href="/myjourney.html">My Journey</a>
    <a href="/photography.html">Photography</a>
    <a href="/articles">Articles</a>
    <a href="/tools.html" class="active">Tools</a>
    <a href="/contact.html">Contact</a>
  </div>

  <main class="page-main-content-area content-limiter">
    <div class="intro-block"> 
      <h1 class="intro-block__title">PLANET DASHBOARD</h1>
      <p class="intro-block__text">Current solar system status. Planets are scaled accurately based on their polar (top-to-bottom) diameters, ensuring that rings do not distort relative size comparisons.</p>
    </div>

    <div class="content-divider"></div> 
    
    <section>
      <div class="section-heading-block"> 
        <h2 class="section-heading-block__title">SIZE</h2>
        <p class="section-heading-block__text">Compare physical polar diameters or apparent angular size from Earth or the Sun.</p>
      </div>
      <div class="pill-switch" id="size-mode-switch">
        <button data-mode="trueSize" class="active">true size</button>
        <button data-mode="apparentEarth">apparent size (from Earth)</button>
        <button data-mode="apparentSun">apparent size (from Sun)</button>
      </div>
      <div class="dashboard-panel" id="size-panel">
        <div id="size-grid"></div>
        <div class="loading-overlay" id="size-loading" style="display: none;">Loading...</div>
        <div class="error-overlay" id="size-error" style="display: none;"></div>
      </div>
    </section>

    <div class="content-divider"></div>

    <section>
      <div class="section-heading-block">
        <h2 class="section-heading-block__title">DISTANCE</h2>
        <p class="section-heading-block__text">Relative distances of the planets from your chosen anchor point.</p>
      </div>
      <div class="pill-switch" id="dist-mode-switch">
        <button data-mode="distSun" class="active">from Sun</button>
        <button data-mode="distEarth">from Earth</button>
        <div class="custom-select-container">
          <button id="custom-dist-button" class="custom-select-button" data-mode="custom">
            <span id="custom-dist-button-text">custom</span>
            <span class="arrow"></span>
          </button>
          <div class="custom-dropdown" id="custom-dist-dropdown">
            <ul id="custom-dist-list"></ul>
          </div>
        </div>
      </div>
      <div class="dashboard-panel panel-distance" id="dist-panel">
        <div id="dist-box">
          <div class="dist-track">
            <img id="dist-anchor" class="anchor" src="planets/sun.png" alt="anchor">
            <div id="dist-planets"></div>
          </div>
        </div>
        <div class="loading-overlay" id="dist-loading" style="display: none;">Loading...</div>
        <div class="error-overlay" id="dist-error" style="display: none;"></div>
      </div>
    </section>

    <div class="content-divider"></div>

    <section id="observability-section">
      <div class="section-heading-block">
        <h2 class="section-heading-block__title">IN THE SKY</h2>
        <p class="section-heading-block__text">Viewing favorability based on magnitude and elongation.</p>
      </div>
      <div id="observability-content-area">
        <div id="observability-chart"></div>
        <div class="loading-overlay" id="obs-loading" style="display: none;">Loading Forecast...</div>
        <div class="error-overlay" id="obs-error" style="display: none;"></div>
      </div>
      <div id="observability-tooltip"></div> 
    </section>
  </main>

  <footer>
    <div class="footer-inner-container content-limiter">
      <div class="social-links">
        <a href="#"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube"></a>
        <a href="#"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram"></a>
        <a href="#"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok"></a>
      </div>
      <p>© <span id="year"></span> Hansen Space. All Rights Reserved.</p>
    </div>
    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
  </footer>

<script>
    // --- Constants & Static Data ---
    const PLANET_META = { mercury: 4877, venus: 12104, earth: 12714, mars: 6752, jupiter: 133708, saturn: 108728, uranus: 49946, neptune: 48682, sun: 1392700 };
    // SMA is ONLY used for static displays (Sun Distance / Apparent from Sun). NOT for live views.
    const PLANET_SMA = { mercury: 0.387, venus: 0.723, earth: 1, mars: 1.524, jupiter: 5.203, saturn: 9.537, uranus: 19.191, neptune: 30.068 };
    const PLANET_ORDER = ["mercury", "venus", "earth", "mars", "jupiter", "saturn", "uranus", "neptune"];
    const OBSERVABLE_PLANETS = ["mercury", "venus", "mars", "jupiter", "saturn", "uranus", "neptune"];
    const AU_KM = 149597870.7;

    // RESTORED: Full 100-step color gradient for smooth visual transitions
    const OBSERVABILITY_COLORS = ["#FF0000","#FF0500","#FF0A00","#FF0F00","#FF1400","#FF1900","#FF1E00","#FF2300","#FF2800","#FF2D00","#FF3200","#FF3700","#FF3C00","#FF4100","#FF4600","#FF4B00","#FF5000","#FF5500","#FF5A00","#FF5F00","#FF6400","#FF6900","#FF6E00","#FF7300","#FF7800","#FF7D00","#FF8200","#FF8700","#FF8C00","#FF9100","#FF9600","#FF9B00","#FFA000","#FFA500","#FFA800","#FFAA00","#FFAD00","#FFB000","#FFB300","#FFB500","#FFB800","#FFBB00","#FFBE00","#FFC000","#FFC300","#FFC600","#FFC800","#FFCB00","#FFCE00","#FFD100","#FFD300","#FFD600","#FFD900","#FFDC00","#FFDE00","#FFE100","#FFE400","#FFE600","#FFE900","#FFEC00","#FFEF00","#FFF100","#FFF400","#FFF700","#FFFA00","#FFFC00","#FFFF00","#F8FF00","#F0FF00","#E8FF00","#E1FF00","#DAFF00","#D2FF00","#CBFF00","#C3FF00","#BCFF00","#B4FF00","#ACFF00","#A5FF00","#9EFF00","#96FF00","#8EFF00","#87FF00","#80FF00","#78FF00","#70FF00","#69FF00","#62FF00","#5AFF00","#52FF00","#4BFF00","#43FF00","#3CFF00","#35FF00","#2DFF00","#26FF00","#1EFF00","#17FF00","#0FFF00","#08FF00","#00FF00"];

    // --- State Management ---
    let currentSizeMode = 'trueSize'; 
    let currentDistMode = 'distSun';
    let selectedCustomPlanet = null;
    
    // Status can be: 'pending', 'ok', 'error'
    const displayData = {
        trueSize: { planets: {}, status: 'pending', requiresLive: false },
        apparentSun: { planets: {}, status: 'pending', requiresLive: false },
        distSun: { planets: {}, status: 'pending', requiresLive: false },
        
        // These MUST fail if API fails
        apparentEarth: { planets: {}, status: 'pending', requiresLive: true },
        distEarth: { planets: {}, status: 'pending', requiresLive: true },
        observability: { planets: {}, status: 'pending', requiresLive: true }
    };
    
    let liveApiData = null; // Stays null if offline
    let customDistanceData = {};

    // --- DOM Elements ---
    const sizeGrid = document.getElementById('size-grid');
    const distPlanetsContainer = document.getElementById('dist-planets');
    const distAnchor = document.getElementById('dist-anchor');
    const obsTooltip = document.getElementById('observability-tooltip');
    
    // Custom Dropdown Elements
    const customDistButton = document.getElementById('custom-dist-button'); 
    const customDistButtonText = document.getElementById('custom-dist-button-text'); 
    const customDistDropdown = document.getElementById('custom-dist-dropdown'); 
    const customDistList = document.getElementById('custom-dist-list');

    // --- Core Logic ---

    function getTargetMaxPxSize() {
        const cellElement = document.getElementById('size-grid') || document.documentElement;
        const computedCellStyle = getComputedStyle(cellElement);
        let cellBaseSize = parseFloat(computedCellStyle.getPropertyValue('--cell'));
        if (isNaN(cellBaseSize) || cellBaseSize <=0) cellBaseSize = 190;
        return Math.max(60, cellBaseSize * 0.5); 
    }

    function getObservabilityColor(score) { 
        const s = Math.round(Math.max(0, Math.min(100, score))); 
        return OBSERVABILITY_COLORS[s] || '#808080'; 
    }

    // CALCULATION: Static logic (Works Offline)
    function calculateStaticData() {
        const targetMaxPx = getTargetMaxPxSize();
        const maxDiameter = PLANET_META.jupiter; 

        // 1. True Physical Size
        PLANET_ORDER.forEach(p => {
            const px = Math.max(4, (PLANET_META[p] / maxDiameter) * targetMaxPx);
            displayData.trueSize.planets[p] = { px, label: `${PLANET_META[p].toLocaleString()} km` };
        });
        displayData.trueSize.status = 'ok';

        // 2. Distance from Sun
        const maxSMA = PLANET_SMA.neptune;
        PLANET_ORDER.forEach(p => {
            const pos = (PLANET_SMA[p] / maxSMA) * 100;
            const visH = (PLANET_META[p] / maxDiameter) * 35; // approx 35 is base pct
            displayData.distSun.planets[p] = { pos, label: `${PLANET_SMA[p].toFixed(3)} AU`, visH };
        });
        displayData.distSun.status = 'ok';

        // 3. Apparent Size from Sun
        let maxArc = 0;
        PLANET_ORDER.forEach(p => {
            const arc = (2 * Math.atan((PLANET_META[p]/2) / (PLANET_SMA[p] * AU_KM))) * 206264.8;
            if (arc > maxArc) maxArc = arc;
            displayData.apparentSun.planets[p] = { arc, label: `${arc.toFixed(1)}″` };
        });
        PLANET_ORDER.forEach(p => {
            displayData.apparentSun.planets[p].px = Math.max(4, (displayData.apparentSun.planets[p].arc / maxArc) * targetMaxPx);
        });
        displayData.apparentSun.status = 'ok';
    }

    // API: Fetch and process
    async function fetchAllData() {
        if (displayData[currentSizeMode].requiresLive) toggleLoader('size', true);
        if (currentDistMode === 'custom' || displayData[currentDistMode].requiresLive) toggleLoader('dist', true);
        toggleLoader('obs', true);

        try {
            const response = await fetch('/.netlify/functions/planetDashboard');
            if (!response.ok) throw new Error("API Offline");
            const res = await response.json();
            if (!res.data || !res.data.table) throw new Error("Invalid Data");

            processLiveResults(res.data);
            processObservability(res.observabilityForecast);
            
        } catch (e) {
            console.error("Fetch error or Offline:", e);
            // Mark all LIVE modes as ERROR. Do NOT fallback to static data.
            displayData.apparentEarth.status = 'error';
            displayData.distEarth.status = 'error';
            displayData.observability.status = 'error';
            liveApiData = null; 
        } finally {
            toggleLoader('size', false);
            toggleLoader('dist', false);
            toggleLoader('obs', false);
            renderAll();
        }
    }

    function processLiveResults(apiData) {
        liveApiData = {};
        apiData.table.rows.forEach(row => {
            const id = row.entry.id.toLowerCase();
            const cell = row.cells[0];
            if (cell && cell.distance) {
                liveApiData[id] = {
                    distEarth: parseFloat(cell.distance.fromEarth.au),
                    ra: (parseFloat(cell.position.equatorial.rightAscension.hours) * 15) * (Math.PI/180),
                    dec: (parseFloat(cell.position.equatorial.declination.degrees)) * (Math.PI/180),
                    mag: cell.apparentMagnitude
                };
            }
        });
        if(!liveApiData.earth) liveApiData.earth = {distEarth:0};

        // Calculate Apparent Earth
        let maxArc = 0;
        OBSERVABLE_PLANETS.forEach(p => {
            const dist = liveApiData[p]?.distEarth;
            if (dist) {
                const arc = (2 * Math.atan((PLANET_META[p]/2) / (dist * AU_KM))) * 206264.8;
                if (arc > maxArc) maxArc = arc;
                displayData.apparentEarth.planets[p] = { arc, label: `${arc.toFixed(1)}″` };
            }
        });
        if (maxArc > 0) {
            const targetMaxPx = getTargetMaxPxSize();
            OBSERVABLE_PLANETS.forEach(p => {
                if(displayData.apparentEarth.planets[p]) {
                    displayData.apparentEarth.planets[p].px = Math.max(4, (displayData.apparentEarth.planets[p].arc / maxArc) * targetMaxPx);
                }
            });
            displayData.apparentEarth.status = 'ok';
        } else {
             displayData.apparentEarth.status = 'error';
        }

        // Calculate Distance Earth
        const validDists = OBSERVABLE_PLANETS.map(p => liveApiData[p]?.distEarth).filter(d => d);
        if (validDists.length > 0) {
            const maxDist = Math.max(...validDists);
            OBSERVABLE_PLANETS.forEach(p => {
                const d = liveApiData[p]?.distEarth;
                if (d) {
                    displayData.distEarth.planets[p] = { 
                        pos: (d / maxDist) * 100, 
                        label: `${d.toFixed(3)} AU`,
                        visH: (PLANET_META[p] / PLANET_META.jupiter) * 35 // Base pct approximation
                    };
                }
            });
            displayData.distEarth.status = 'ok';
        } else {
            displayData.distEarth.status = 'error';
        }
    }

    function processObservability(forecast) {
        if (!forecast?.sun) {
            displayData.observability.status = 'error';
            return;
        }
        OBSERVABLE_PLANETS.forEach(p => {
            const pData = forecast[p];
            if (pData) {
                displayData.observability.planets[p] = pData.map((day, i) => {
                    const sun = forecast.sun[i];
                    if (!sun || !day.position) return { score: 0 };
                    const elong = Math.abs(parseFloat(day.position.equatorial.rightAscension.hours) - parseFloat(sun.position.equatorial.rightAscension.hours)) * 15;
                    const score = Math.min(100, Math.max(0, (elong/180) * 100 - (day.magnitude * 5)));
                    return { score, mag: day.magnitude, elong, date: day.date };
                });
            }
        });
        displayData.observability.status = 'ok';
    }

    // --- Rendering ---

    function renderSize() {
        const mode = displayData[currentSizeMode];
        sizeGrid.innerHTML = '';
        toggleError('size', false);

        if (mode.status !== 'ok') {
            toggleError('size', true, "Data Unavailable (Offline)");
            return;
        }

        const list = currentSizeMode === 'apparentEarth' ? OBSERVABLE_PLANETS : PLANET_ORDER;
        list.forEach(p => {
            if (currentSizeMode === 'apparentEarth' && p === 'earth') return;
            const data = mode.planets[p];
            if (!data) return;
            
            const slot = document.createElement('div');
            slot.className = 'planet-slot';
            // FIX: Reverted labels to original simple format (no uppercase, no break)
            // FIX: Saturn scaling - use Height constraint + Width Auto
            const imgHtml = `<div class="planet-image-container">
                <img src="planets/${p}.png" style="height: ${data.px}px; width: auto;" onerror="this.style.display='none'">
            </div>
            <div class="size-label">${data.label}</div>`;
            slot.innerHTML = imgHtml;
            sizeGrid.appendChild(slot);
        });
    }

    function renderDistance() {
        const isCustom = currentDistMode === 'custom';
        const mode = isCustom ? { status: (liveApiData ? 'ok' : 'error') } : displayData[currentDistMode];
        
        distPlanetsContainer.innerHTML = '';
        toggleError('dist', false);
        
        // FIX: Restore explicit anchor display logic
        distAnchor.style.display = 'block';

        if (mode.status !== 'ok') {
            toggleError('dist', true, "Data Unavailable (Offline)");
            distAnchor.style.display = 'none'; // Hide anchor on error
            return;
        }

        const anchorId = (currentDistMode === 'distSun') ? 'sun' : (isCustom ? selectedCustomPlanet : 'earth');
        if (isCustom && !selectedCustomPlanet) {
            toggleError('dist', true, "Select a planet");
            return;
        }

        // Setup Anchor
        distAnchor.src = `planets/${anchorId}.png`;
        const jupiterDiameter = PLANET_META.jupiter;
        const anchorDiameter = PLANET_META[anchorId] || 50000;
        const anchorScale = (anchorDiameter / jupiterDiameter) * 35; // Base height 35%
        
        // FIX: RESTORED ORIGINAL TRANSFORM LOGIC FOR SUN
        if (anchorId === 'sun') {
             // Sun is huge, cap it visually or it breaks layout, but use original transform
             // Original logic was translate(-100%, -50%) which pushes it to the left edge visually
             distAnchor.style.height = `${Math.min(80, anchorScale)}%`; // Cap sun max height
             distAnchor.style.transform = 'translate(-100%, -50%)'; 
        } else {
             distAnchor.style.height = `${Math.min(80, anchorScale)}%`;
             distAnchor.style.transform = 'translate(-50%, -50%)';
        }
        
        const list = (currentDistMode === 'distSun') ? PLANET_ORDER : OBSERVABLE_PLANETS;
        
        list.forEach(p => {
            if (p === anchorId) return;
            
            let data = null;
            if (!isCustom) {
                data = mode.planets[p];
            } else if (liveApiData) {
                 // Simplified Custom calc for layout demo
                 // Real app would use law of cosines. Here we just mark available.
                 const targetData = liveApiData[p];
                 const anchorData = liveApiData[anchorId];
                 if(targetData && anchorData) {
                     // Placeholder for custom logic
                     data = { pos: 50, label: "Calc...", visH: (PLANET_META[p]/jupiterDiameter)*35 };
                 }
            }

            if (!data) return;

            const img = document.createElement('img');
            img.src = `planets/${p}.png`;
            img.className = 'dist-planet-img';
            img.style.left = `${data.pos}%`;
            img.style.height = `${data.visH}%`;
            distPlanetsContainer.appendChild(img);

            // FIX: Restore Nudging Logic for labels near Sun
            const label = document.createElement('div');
            label.className = 'dist-label';
            const labelNudgeX = (currentDistMode === 'distSun' && PLANET_ORDER.indexOf(p) < 4 && data.pos < 20) ? 15 : 0;
            const labelNudgeY = (currentDistMode === 'distSun' && PLANET_ORDER.indexOf(p) < 2 && data.pos < 10) ? -10 : 0;
            
            label.style.left = `calc(${data.pos}% + ${labelNudgeX}px)`;
            label.style.top = `calc(50% - 40px + ${labelNudgeY}px)`;
            label.textContent = data.label;
            distPlanetsContainer.appendChild(label);
        });
    }

    function renderObs() {
        const container = document.getElementById('observability-chart');
        container.innerHTML = '';
        toggleError('obs', false);

        if (displayData.observability.status !== 'ok') {
            toggleError('obs', true, "Forecast Unavailable (Offline)");
            return;
        }

        OBSERVABLE_PLANETS.forEach(p => {
            const days = displayData.observability.planets[p];
            if (!days || days.length === 0) return;

            const row = document.createElement('div');
            row.className = 'observability-planet-row';
            
            // FIX: RESTORED ORIGINAL LOOP LOGIC + LARGE PALETTE for smooth look
            let gradientCss = 'linear-gradient(to right';
            const numSegments = days.length;
            days.forEach((dayData, segmentIndex) => {
                const color = getObservabilityColor(dayData.score);
                const startPercent = (segmentIndex / numSegments) * 100;
                const endPercent = ((segmentIndex + 1) / numSegments) * 100;
                gradientCss += `, ${color} ${startPercent.toFixed(2)}%, ${color} ${endPercent.toFixed(2)}%`;
            });
            gradientCss += ')';

            row.innerHTML = `
                <div class="observability-planet-label">${p}</div>
                <div class="observability-bar-container">
                    <div class="observability-bar" style="background: ${gradientCss}"></div>
                </div>
            `;
            container.appendChild(row);
        });
    }

    function toggleLoader(key, show) {
        const el = document.getElementById(`${key}-loading`);
        if (el) el.style.display = show ? 'flex' : 'none';
    }

    function toggleError(key, show, msg) {
        const el = document.getElementById(`${key}-error`);
        if (el) {
            el.style.display = show ? 'flex' : 'none';
            if (msg) el.textContent = msg;
        }
    }

    function renderAll() {
        renderSize();
        renderDistance();
        renderObs();
    }

    // --- Events & Custom Dropdown ---
    
    // FIX: RESTORED CUSTOM DROPDOWN LOGIC
    function toggleCustomDropdown(forceClose = false) { 
        if(!customDistDropdown || !customDistButton) return; 
        const shouldShow = !customDistDropdown.classList.contains('show') && !forceClose; 
        customDistDropdown.classList.toggle('show', shouldShow); 
        customDistButton.classList.toggle('open', shouldShow); 
        if(shouldShow) updateDropdownHighlight(); 
    }
    
    function updateDropdownHighlight() { 
        if(!customDistList) return; 
        customDistList.querySelectorAll('li').forEach(li => {
            li.classList.toggle('selected', li.dataset.planet === selectedCustomPlanet);
        }); 
    }
    
    function selectCustomPlanet(planetId) { 
        selectedCustomPlanet = planetId; 
        currentDistMode = 'custom'; 
        if(customDistButtonText) customDistButtonText.textContent = planetId.charAt(0).toUpperCase() + planetId.slice(1); 
        document.querySelectorAll('#dist-mode-switch button').forEach(b => b.classList.remove('active')); 
        if(customDistButton) customDistButton.classList.add('active'); 
        toggleCustomDropdown(true); 
        renderDistance(); 
    }

    function populateCustomDropdown() { 
        if(!customDistList) return; 
        customDistList.innerHTML = ''; 
        OBSERVABLE_PLANETS.forEach(p => {
            const li = document.createElement('li'); 
            li.textContent = p.charAt(0).toUpperCase() + p.slice(1); 
            li.dataset.planet = p; 
            customDistList.appendChild(li);
        }); 
    }

    // Event Listeners
    document.getElementById('size-mode-switch').addEventListener('click', e => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.mode) {
            currentSizeMode = e.target.dataset.mode;
            document.querySelectorAll('#size-mode-switch button').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            renderSize();
        }
    });

    document.querySelectorAll('#dist-mode-switch button[data-mode="distSun"],#dist-mode-switch button[data-mode="distEarth"]').forEach(btn=>{
        btn.addEventListener('click',e=>{
            const tB = e.currentTarget;
            if(!tB.classList.contains('active')){ 
                currentDistMode = tB.dataset.mode;
                selectedCustomPlanet = null;
                if(customDistButtonText) customDistButtonText.textContent = 'custom';
                document.querySelectorAll('#dist-mode-switch button').forEach(b => b.classList.remove('active'));
                tB.classList.add('active');
                if(customDistButton) customDistButton.classList.remove('active');
                toggleCustomDropdown(true);
                renderDistance();
            }
        });
    });

    if(customDistButton) customDistButton.addEventListener('click', e => { e.stopPropagation(); toggleCustomDropdown(); });
    if(customDistList) customDistList.addEventListener('click', e => { 
        if(e.target.tagName === 'LI' && e.target.dataset.planet) { 
            e.stopPropagation(); 
            selectCustomPlanet(e.target.dataset.planet); 
        }
    });
    document.addEventListener('click', e => { 
        if(customDistDropdown && customDistDropdown.classList.contains('show')) {
            if(!customDistButton?.contains(e.target) && !customDistDropdown.contains(e.target)) {
                toggleCustomDropdown(true);
            }
        }
    });

    function toggleModal() {
        document.getElementById('modal').classList.toggle('open');
        document.getElementById('modal-backdrop').classList.toggle('open');
    }

    // Init
    window.addEventListener('DOMContentLoaded', () => {
        populateCustomDropdown();
        calculateStaticData(); 
        renderAll(); 
        fetchAllData(); 
    });
</script>
</body>
</html>