<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Planets Dashboard – Hansen Space</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Nunito+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css"> <style>
    :root {
      --canvas:1200px;    /* grey strip max width */
      --side-pad:80px;    /* gutters */
      --grey:#2e2e2e;     /* strip bg */
      --cell:200px;       /* size grid cell base - used for scaling */
      --gap:50px;         /* grid gap base */
      --dist-aspect:1000/256; /* native distance chart ratio */

      /* --- Sizing from previous working version --- */
      --dist-planet-base-height-pct: 25%; /* Base height % for Jupiter/Sun */
      --dist-planet-min-height-pct: 3%;   /* Min height % */
      --dist-planet-max-height-pct: 60%;  /* Max height % */
      /* --- END Sizing --- */
    }
    * { box-sizing:border-box; margin:0 }
    body { font-family:'Nunito Sans',sans-serif; background:#fff; color:#eee; overflow-x:hidden; }
    a { color:inherit; text-decoration:none }
    header { display:flex; justify-content:space-between; align-items:center; padding:18px var(--side-pad); background:#fff; color:#111; }
    header nav ul { display:flex; gap:30px; list-style:none; font-weight:600; font-size:16px; }
    header .active { border-bottom:2px solid #111; padding-bottom:3px }
    .menu-icon { display:none; font-size:1.4rem; cursor:pointer; }
    @media(max-width:850px) { header nav { display:none } .menu-icon { display:block } }
    #content { background:var(--grey); padding:0 var(--side-pad) }
    #inner   { max-width:var(--canvas); margin:0 auto; padding:30px 0 }
    .intro-section { display:flex; justify-content:space-between; align-items:center; gap:40px; margin-bottom:60px; }
    .intro-title { font:700 40px/1 'Poppins'; color:#fff }
    .intro-text { max-width:640px; font-size:18px; line-height:1.6; color:#d0d0d0; }
    @media(max-width:850px) { .intro-section { flex-direction:column; text-align:center } }
    .dash-block  { margin-bottom:70px }
    .block-title { font:600 28px/1 'Poppins'; margin-bottom:24px; color:#fff }
    /* --- Adjusted Pill Switch --- */
    .pill-switch {
        display:flex;
        background:#555;
        border-radius:40px;
        overflow:visible; /* Allow dropdown overflow */
        width:max-content;
        margin:0 auto 40px;
        font-size:14px;
        position: relative; /* Needed for dropdown positioning */
    }
    .pill-switch button {
        padding:10px 18px;
        border:none;
        background:transparent;
        color:#eee;
        font-weight:600;
        cursor:pointer;
        display: flex; /* For aligning text and arrow */
        align-items: center;
        gap: 5px; /* Space between text and arrow */
        border-radius: 40px; /* Apply radius to individual buttons too */
    }
    .pill-switch button.active { background:#fff; color:#000; }
    .pill-switch button:disabled { color: #888; cursor: not-allowed; }
    /* Separate container needed because overflow:hidden on parent clips dropdown */
    .pill-switch > div { /* Target direct div children (like the custom select container) */
        border-radius: 40px; /* Apply radius to the container */
        overflow: visible; /* Ensure container doesn't clip */
    }


    /* --- Custom Dropdown Styles --- */
    .custom-select-container { position: relative; } /* Container for button + dropdown */
    .custom-select-button .arrow {
        display: inline-block;
        width: 0; height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid currentColor; /* Default down arrow */
        margin-left: 8px;
        transition: transform 0.2s ease-in-out;
    }
    .custom-select-button.open .arrow {
        transform: rotate(180deg); /* Up arrow when open */
    }
    .custom-dropdown {
        display: none; /* Hidden by default */
        position: absolute;
        top: calc(100% + 5px); /* Position below the button with gap */
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        border: 1px solid #666;
        border-radius: 4px;
        padding: 5px 0;
        z-index: 20;
        min-width: 150px;
        max-height: 200px; /* Limit height */
        overflow-y: auto; /* Add scroll if needed */
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .custom-dropdown.show { display: block; } /* Show when active */
    .custom-dropdown ul { list-style: none; padding: 0; margin: 0; }
    .custom-dropdown li {
        padding: 8px 15px;
        color: #eee;
        cursor: pointer;
        font-size: 13px;
        white-space: nowrap;
    }
    .custom-dropdown li:hover { background-color: #555; }
    .custom-dropdown li.selected { background-color: #777; font-weight: bold; }
    /* --- End Dropdown Styles --- */

    /* panels */
    .panel {
      background:#000;
      border-radius:6px;
      padding:48px 20px;
      margin-bottom:50px;
      position: relative;
      min-height: 150px;
      overflow: hidden; /* Clip content (like oversized Sun anchor) */
    }
    .loading-overlay, .error-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; text-align: center; z-index: 10; color: #eee; font-size: 16px; padding: 20px; pointer-events: none; }
    .error-overlay { color: #ffaaaa; }

    /* SIZE grid */
    #size-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(var(--cell),1fr)); grid-auto-rows:var(--cell); gap:var(--gap); justify-content:center; }
    .planet-slot { position:relative; display:flex; flex-direction: column; justify-content:center; align-items:center; }
    .planet-image-container { flex-grow: 1; display: flex; justify-content: center; align-items: center; width: 100%; height: 100%; }
    .planet-image-container img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .size-label { position:absolute; bottom:-26px; left:50%; transform:translateX(-50%); font-size:14px; color:#eee; white-space:nowrap; }

    /* DISTANCE chart */
    .panel-distance { padding-top:48px; padding-bottom:48px }
    #dist-box { width:80%; max-width:var(--canvas); margin:0 auto; aspect-ratio: var(--dist-aspect); position:relative; min-height: 150px; }
    .dist-track { position:absolute; top:0; left:0; width:100%; height:100%; }
    .dist-track::before { content:""; position:absolute; top:50%; left:0; width:100%; height:2px; background:#666; transform:translateY(-50%); }
    .anchor {
        position:absolute;
        left:0;
        top:50%;
        /* Transform set dynamically in JS */
        z-index: 5;
        width: auto;
        max-height: var(--dist-planet-max-height-pct);
    }
    #dist-planets { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #dist-planets .dist-planet-img {
        position:absolute; top:50%; transform:translate(-50%,-50%);
        width:auto; /* Height controls size */
        min-height: var(--dist-planet-min-height-pct);
        max-height: var(--dist-planet-max-height-pct);
        z-index: 4;
        object-fit: contain;
     }
    #dist-planets .dist-label { position:absolute; top:calc(50% - 40px); color:#ddd; white-space:nowrap; transform-origin:top left; transform:rotate(-40deg); font-size: clamp(10px, 1.2vw, 14px); z-index: 6; }
    .div { height:1px; background:#555; margin:50px 0 }
    footer { padding:20px var(--side-pad); background:#fff; text-align:center; font-size:14px; color:#999; }
    footer .social-links { margin-bottom:12px }
    footer .social-links img { height:24px; margin:0 10px; }

    /* mobile tweaks */
    @media(max-width:850px) {
      :root {
          --side-pad:20px;
          --cell: calc(200px*0.7);
          --gap: calc(50px *0.7);
          /* --- ADJUSTED mobile base size --- */
          --dist-planet-base-height-pct: 25%; /* Slightly smaller base on mobile */
       }
      body { font-size:90% }
      .intro-title { font-size: 26px; } .intro-text  { font-size: 14px; } .block-title { font-size: 22px; } .pill-switch { font-size: 12px; }
      .size-label { font-size:12px }
      #dist-planets .dist-label { font-size: clamp(9px, 1.3vw, 12px); top:calc(50% - 30px); }
      header nav ul { font-size:14px }
    }
  </style>
</head>
<body>

  <header>
    <a class="brand" href="/"><img src="/images/logo.png" alt="Hansen Space"></a>
    <nav><ul>
      <li><a href="/">Home</a></li><li><a href="/myjourney.html">My Journey</a></li><li><a href="/photography.html">Photography</a></li><li><a href="/articles">Articles</a></li><li><a href="/tools.html" class="active">Tools</a></li><li><a href="/contact.html">Contact</a></li>
    </ul></nav>
    <div class="menu-icon" onclick="toggleModal()">☰</div>
  </header>

  <div id="content">
    <div id="inner">

      <div class="intro-section">
        <h2 class="intro-title">PLANET DASHBOARD</h2>
        <p class="intro-text">A planetary dashboard for all of your needs.</p>
      </div>

      <section class="dash-block">
        <h3 class="block-title">SIZE</h3>
        <div class="pill-switch" id="size-mode-switch">
          <button data-mode="trueSize">true size</button>
          <button data-mode="apparentEarth" class="active">apparent size (from Earth)</button>
          <button data-mode="apparentSun">apparent size (from Sun)</button>
        </div>
        <div class="panel" id="size-panel">
          <div id="size-grid"></div>
           <div class="loading-overlay" id="size-loading" style="display: none;">Loading Size Data...</div>
           <div class="error-overlay" id="size-error" style="display: none;"></div>
        </div>
      </section>

      <section class="dash-block">
        <h3 class="block-title">DISTANCE</h3>
        <div class="pill-switch" id="dist-mode-switch">
           <button data-mode="distSun">from Sun</button>
          <button data-mode="distEarth" class="active">from Earth</button>
          <div class="custom-select-container">
              <button id="custom-dist-button" class="custom-select-button" data-mode="custom">
                  <span id="custom-dist-button-text">custom</span>
                  <span class="arrow"></span> </button>
              <div class="custom-dropdown" id="custom-dist-dropdown">
                  <ul id="custom-dist-list">
                      </ul>
              </div>
          </div>
        </div>
        <div class="panel panel-distance" id="dist-panel">
          <div id="dist-box">
            <div class="dist-track">
              <img id="dist-anchor" class="anchor" src="planets/earth.png" alt="anchor">
              <div id="dist-planets"></div>
            </div>
            <div class="loading-overlay" id="dist-loading" style="display: none;">Loading Distance Data...</div>
            <div class="error-overlay" id="dist-error" style="display: none;"></div>
          </div>
        </div>
      </section>

      <div class="div"></div>

      <section class="dash-block">
        <h3 class="block-title">IN THE SKY (coming soon)</h3>
        <p style="color:#ccc">Feature under construction.</p>
      </section>

    </div>
  </div>

  <footer>
    <div class="social-links">
      <a href="https://www.youtube.com/hansenspace"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube"></a><a href="https://instagram.com/hansenspace"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram"></a><a href="https://tiktok.com/@hansen_space"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok"></a>
    </div>
    <p>© <span id="year"></span> Hansen Space.</p>
    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
  </footer>

 <script>
    // --- Static Data ---
    const PLANET_META = { mercury: 4879, venus: 12104, earth: 12756, mars: 6779, jupiter: 139820, saturn: 116460, uranus: 50724, neptune: 49244, sun: 1392700 }; // Added Sun diameter
    const PLANET_SMA = { mercury: 0.387, venus: 0.723, earth: 1, mars: 1.524, jupiter: 5.203, saturn: 9.537, uranus: 19.191, neptune: 30.068 };
    const SATURN_RING_FACTOR = 1206 / 2737;
    const PLANET_ORDER = ["mercury", "venus", "earth", "mars", "jupiter", "saturn", "uranus", "neptune"];
    const CUSTOM_PLANET_OPTIONS = ["mercury", "venus", "mars", "jupiter", "saturn", "uranus", "neptune"]; // Excludes Earth & Sun
    const AU_KM = 149597870.7;
    const REFRESH_INTERVAL_MS = 5 * 60 * 1000;

    // --- Read CSS Variables for dynamic sizing ---
    function getCssVariableValue(varName) { const panelElement = document.getElementById('size-panel') || document.documentElement; const value = getComputedStyle(panelElement).getPropertyValue(varName).trim(); return parseFloat(value) || 0; }
    function getTargetMaxPxSize() { const cellBaseSize = getCssVariableValue('--cell'); const targetSize = cellBaseSize > 0 ? cellBaseSize * 0.95 : 190; return Math.max(60, targetSize); }

    // Use JS constants for distance chart sizes
    const BASE_PLANET_VISUAL_HEIGHT_PCT = getCssVariableValue('--dist-planet-base-height-pct') || 30; // Read from CSS or fallback
    const MIN_PLANET_VISUAL_HEIGHT_PCT = getCssVariableValue('--dist-planet-min-height-pct') || 4;
    const MAX_PLANET_VISUAL_HEIGHT_PCT = getCssVariableValue('--dist-planet-max-height-pct') || 70;

    // --- State ---
    let currentSizeMode = 'apparentEarth';
    let currentDistMode = 'distEarth'; // Can be 'distSun', 'distEarth', or 'custom'
    let selectedCustomPlanet = null; // Stores the ID of the selected custom planet
    let liveApiData = null;
    let apiFetchError = null;
    let apiRefreshTimer = null;
    let hasLoggedApiStructure = false; // Keep for debugging

    // --- Display Data Storage ---
    const displayData = {
        trueSize: { planets: {}, requires_live: false, status: 'pending' },
        apparentEarth: { planets: {}, requires_live: true, status: 'pending' },
        apparentSun: { planets: {}, requires_live: false, status: 'pending' },
        distSun: { planets: {}, requires_live: false, status: 'pending' },
        distEarth: { planets: {}, requires_live: true, status: 'pending' },
        // Custom mode data will be handled differently if implemented later
    };

    // --- DOM Elements ---
    const sizeGrid = document.getElementById('size-grid');
    const distAnchor = document.getElementById('dist-anchor');
    const distPlanetsContainer = document.getElementById('dist-planets');
    const sizeLoading = document.getElementById('size-loading');
    const sizeError = document.getElementById('size-error');
    const distLoading = document.getElementById('dist-loading');
    const distError = document.getElementById('dist-error');
    // Custom Dropdown Elements
    const customDistButton = document.getElementById('custom-dist-button');
    const customDistButtonText = document.getElementById('custom-dist-button-text');
    const customDistDropdown = document.getElementById('custom-dist-dropdown');
    const customDistList = document.getElementById('custom-dist-list');


    // --- Calculation Functions ---
    function getAngularSizeArcsec(diameterKm, distanceAu) { /* ... (unchanged) ... */ if (!diameterKm || !distanceAu || distanceAu <= 0) return 0; const distanceKm = distanceAu * AU_KM; const radiusKm = diameterKm / 2; const radians = 2 * Math.atan(radiusKm / distanceKm); return radians * 206264.806; }

    // Mode 1: True Size - Uses getTargetMaxPxSize
    function calculateTrueSizeData() {
        console.log("[Calc] Calculating True Size data...");
        const modeData = displayData.trueSize; modeData.planets = {}; modeData.status = 'pending'; modeData.error = null;
        const targetMaxPx = getTargetMaxPxSize();
        let maxDiameter = 0; const diameters = {};
        PLANET_ORDER.forEach(p => { diameters[p] = PLANET_META[p]; if (diameters[p] > maxDiameter) maxDiameter = diameters[p]; });
        if (maxDiameter <= 0) { console.error("[Calc True Size] Max diameter invalid."); modeData.status = 'error'; modeData.error = 'Invalid planet data'; return; }
        PLANET_ORDER.forEach(p => { const diameter = diameters[p]; const px = Math.max(4, (diameter / maxDiameter) * targetMaxPx); modeData.planets[p] = { px: px, label: `${(diameter / 2).toLocaleString()} km` }; });
        modeData.status = 'ok'; console.log(`[Calc True Size] Data calculated. Target Px: ${targetMaxPx}`);
    }

    // Mode 3: Apparent Size from Sun (using SMA) - Uses getTargetMaxPxSize
    function calculateApparentSunData() {
        console.log("[Calc] Calculating Apparent Size from Sun data (using SMA)...");
        const modeData = displayData.apparentSun; modeData.planets = {}; modeData.status = 'pending'; modeData.error = null;
        const targetMaxPx = getTargetMaxPxSize();
        let maxArcSec = 0; const arcSecs = {};
        PLANET_ORDER.forEach(p => { const diameter = PLANET_META[p]; const distanceAu = PLANET_SMA[p]; const arcSec = getAngularSizeArcsec(diameter, distanceAu); arcSecs[p] = arcSec; if (arcSec > maxArcSec) maxArcSec = arcSec; });
        if (maxArcSec <= 0) { console.error("[Calc Apparent Sun] Max arcsec invalid."); modeData.status = 'error'; modeData.error = 'Calculation error'; return; }
        PLANET_ORDER.forEach(p => { const arcSec = arcSecs[p]; const px = Math.max(4, (arcSec / maxArcSec) * targetMaxPx); modeData.planets[p] = { px: px, label: `${arcSec.toFixed(1)}″` }; });
        modeData.status = 'ok'; console.log(`[Calc Apparent Sun] Data calculated. Max Arcsec: ${maxArcSec}, Target Px: ${targetMaxPx}`);
    }

    // Mode 4: Distance from Sun (using SMA) - Uses updated size constants
    function calculateDistSunData() {
        console.log("[Calc] Calculating Distance from Sun data (using SMA)...");
        const modeData = displayData.distSun; modeData.planets = {}; modeData.status = 'pending'; modeData.error = null;
        const maxDist = PLANET_SMA.neptune;
        PLANET_ORDER.forEach(p => {
            const distanceAu = PLANET_SMA[p];
            const pos = (distanceAu / maxDist) * 100;
            // Use updated JS constants for height calculation
            const rawVisualHeightPct = (PLANET_META[p] / PLANET_META.jupiter) * (p === 'saturn' ? SATURN_RING_FACTOR : 1) * BASE_PLANET_VISUAL_HEIGHT_PCT;
            const visualHeightPct = Math.max(MIN_PLANET_VISUAL_HEIGHT_PCT, Math.min(MAX_PLANET_VISUAL_HEIGHT_PCT, rawVisualHeightPct));
            modeData.planets[p] = { pos: pos, label: `${distanceAu.toFixed(3)} AU`, visH: visualHeightPct };
        });
        modeData.status = 'ok'; console.log("[Calc Dist Sun] Data calculated.");
    }

     // Mode 2: Apparent Size from Earth (using Live API Data) - Uses getTargetMaxPxSize
    function calculateApparentEarthData(apiData) {
        console.log("[Calc] Calculating Apparent Size from Earth data...");
        const modeData = displayData.apparentEarth; modeData.planets = {}; modeData.status = 'pending'; modeData.error = null;
        if (!apiData) { console.error("[Calc Apparent Earth] Missing liveApiData."); modeData.status = 'error'; modeData.error = 'API data not available'; return; }
        const targetMaxPx = getTargetMaxPxSize();
        let maxArcSec = 0; const arcSecs = {}; let calculationOk = true; let firstErrorLogged = false;

        PLANET_ORDER.forEach(p => { // First pass: calculate arcsecs, find max
            if (p === 'earth') return;
            const diameter = PLANET_META[p]; const planetApiData = apiData[p]; const distanceAuString = planetApiData?.distance?.fromEarth?.au; let distanceAu = parseFloat(distanceAuString);
            if (isNaN(distanceAu) || distanceAu <= 0) { console.warn(`[Calc Apparent Earth] Missing/invalid distance for ${p}. Raw: ${distanceAuString}`); if (!firstErrorLogged && !hasLoggedApiStructure) { console.log("[Calc Apparent Earth] Logging full liveApiData:", JSON.stringify(apiData, null, 2)); firstErrorLogged = true; hasLoggedApiStructure = true; } arcSecs[p] = -1; calculationOk = false;
            } else { const arcSec = getAngularSizeArcsec(diameter, distanceAu); arcSecs[p] = arcSec; if (arcSec > maxArcSec) maxArcSec = arcSec; }
        });
        if (!calculationOk && maxArcSec <= 0) { console.error("[Calc Apparent Earth] No valid distances found."); modeData.status = 'error'; modeData.error = 'Could not read valid planet distances from API data.'; return; }
        if (maxArcSec <= 0) { console.warn("[Calc Apparent Earth] Max calculated arcsec is zero."); maxArcSec = 1; }

        PLANET_ORDER.forEach(p => { // Second pass: calculate px size
             if (p === 'earth') return;
             const arcSec = arcSecs[p];
             if (arcSec < 0) { modeData.planets[p] = { px: 4, label: `??” (No data)` }; }
             else { const px = Math.max(4, (arcSec / maxArcSec) * targetMaxPx); modeData.planets[p] = { px: px, label: `${arcSec.toFixed(1)}″` }; }
        });
        modeData.status = calculationOk ? 'ok' : 'partial'; modeData.error = calculationOk ? null : 'API data missing required distance field for some planets.';
        console.log(`[Calc Apparent Earth] Data calculated (Status: ${modeData.status}). Max Arcsec: ${maxArcSec}, Target Px: ${targetMaxPx}`);
    }

    // Mode 5: Distance from Earth (using Live API Data) - Uses updated size constants
    function calculateDistEarthData(apiData) {
        console.log("[Calc] Calculating Distance from Earth data...");
        const modeData = displayData.distEarth; modeData.planets = {}; modeData.status = 'pending'; modeData.error = null;
        if (!apiData) { console.error("[Calc Dist Earth] Missing liveApiData."); modeData.status = 'error'; modeData.error = 'API data not available'; return; }
        const distances = []; let calculationOk = true; let firstErrorLogged = false;

        PLANET_ORDER.forEach(p => {
            if (p === 'earth') return;
            const planetApiData = apiData[p]; const distanceAuString = planetApiData?.distance?.fromEarth?.au; let distanceAu = parseFloat(distanceAuString);
            if (!isNaN(distanceAu) && distanceAu > 0) {
                distances.push({ id: p, dist: distanceAu });
                // Use updated JS constants for height calculation
                const rawVisualHeightPct = (PLANET_META[p] / PLANET_META.jupiter) * (p === 'saturn' ? SATURN_RING_FACTOR : 1) * BASE_PLANET_VISUAL_HEIGHT_PCT;
                const visualHeightPct = Math.max(MIN_PLANET_VISUAL_HEIGHT_PCT, Math.min(MAX_PLANET_VISUAL_HEIGHT_PCT, rawVisualHeightPct));
                modeData.planets[p] = { visH: visualHeightPct, label: `${distanceAu.toFixed(3)} AU` };
            } else { console.warn(`[Calc Dist Earth] Missing/invalid distance for ${p}. Raw: ${distanceAuString}. Excluding.`); if (!firstErrorLogged && !hasLoggedApiStructure) { console.log("[Calc Dist Earth] Logging full liveApiData:", JSON.stringify(apiData, null, 2)); firstErrorLogged = true; hasLoggedApiStructure = true; } calculationOk = false; }
        });
        if (distances.length === 0) { console.error("[Calc Dist Earth] No valid distances found."); modeData.status = 'error'; modeData.error = 'Could not read valid planet distances from API data.'; return; }
        const maxDist = Math.max(...distances.map(item => item.dist)); console.log(`[Calc Dist Earth] Max distance (AU): ${maxDist}`);
        distances.forEach(item => { const p = item.id; const distanceAu = item.dist; const pos = (maxDist > 0) ? (distanceAu / maxDist) * 100 : 0; if (modeData.planets[p]) { modeData.planets[p].pos = pos; } });
        modeData.status = calculationOk ? 'ok' : 'partial'; modeData.error = calculationOk ? null : 'API data missing required distance field for some planets.';
        console.log(`[Calc Dist Earth] Data calculated (Status: ${modeData.status})`);
    }


    // --- API Fetch and Update --- (Unchanged from previous version)
    async function fetchAndUpdateLiveData() { /* ... */ }

    // --- Drawing Functions ---
    function showLoading(panelType, isLoading) { /* ... (unchanged) ... */ }
    function showError(panelType, message) { /* ... (unchanged) ... */ }
    function drawSizeGrid() { /* ... (unchanged - uses updated calculate functions) ... */ }

    // Draw Distance Chart - MODIFIED anchor size calculation
    function drawDistanceChart() {
        console.log(`[Draw] Drawing Distance Chart for mode: ${currentDistMode}`);

        // Handle custom mode separately for now
        if (currentDistMode === 'custom') {
            console.log(`[Draw Dist] Custom mode selected (${selectedCustomPlanet}). Displaying placeholder/error.`);
            showLoading('dist', false);
            showError('dist', `Custom view for '${selectedCustomPlanet || 'N/A'}' not yet implemented.`);
            if (distPlanetsContainer) distPlanetsContainer.innerHTML = ''; // Clear planets
            // Set anchor to something generic or hide it? Let's hide it for now.
            if (distAnchor) distAnchor.style.display = 'none';
            return; // Stop drawing for custom mode
        }

        // Proceed for standard modes (distSun, distEarth)
        const modeData = displayData[currentDistMode];
        if (!distAnchor) { console.error("[Draw Dist] Anchor element not found!"); return; }
        if (!modeData || modeData.status === 'pending') { showLoading('dist', true); showError('dist', null); if(distPlanetsContainer) distPlanetsContainer.innerHTML = ''; distAnchor.style.display = 'none'; return; }
        if (modeData.status === 'error') { showLoading('dist', false); showError('dist', modeData.error || 'Failed to load data for this view.'); if(distPlanetsContainer) distPlanetsContainer.innerHTML = ''; distAnchor.style.display = 'none'; return; }

        // Show anchor if drawing standard mode
        distAnchor.style.display = 'block';
        showLoading('dist', false); showError('dist', modeData.status === 'partial' ? (modeData.error || 'Note: Some planets may be missing.') : null);

        const planetDataMap = modeData.planets;
        if(distPlanetsContainer) distPlanetsContainer.innerHTML = '';

        const isSunMode = currentDistMode === 'distSun';
        distAnchor.src = isSunMode ? 'planets/sun.png' : 'planets/earth.png';

        // *** CALCULATE ANCHOR SIZE BASED ON MODE & TRUE SIZE ***
        let anchorVisH;
        if (isSunMode) {
             // Sun anchor size = Relative to Jupiter, using Sun's diameter
             anchorVisH = (PLANET_META.sun / PLANET_META.jupiter) * BASE_PLANET_VISUAL_HEIGHT_PCT;
        } else {
             // Earth anchor size = Relative to Jupiter
             anchorVisH = (PLANET_META.earth / PLANET_META.jupiter) * BASE_PLANET_VISUAL_HEIGHT_PCT;
        }
        // Clamp anchor size using JS constants
        distAnchor.style.height = `${Math.max(MIN_PLANET_VISUAL_HEIGHT_PCT, Math.min(MAX_PLANET_VISUAL_HEIGHT_PCT, anchorVisH))}%`;

        // Adjust transform for Sun alignment
        if (isSunMode) { distAnchor.style.transform = 'translate(0%, -50%)'; /* Align LEFT edge at 0, center vertically */ } // Corrected Sun alignment
        else { distAnchor.style.transform = 'translate(-50%, -50%)'; /* Center align */ }
        console.log(`[Draw Dist] Anchor set to ${distAnchor.src}, height: ${distAnchor.style.height}, transform: ${distAnchor.style.transform}`);

        // Render planets (unchanged logic, uses updated size constants)
        const planetsToShow = isSunMode ? PLANET_ORDER : PLANET_ORDER.filter(p => p !== 'earth');
        planetsToShow.forEach((p, index) => {
             const planetData = planetDataMap[p];
             if (planetData && typeof planetData.pos === 'number') {
                 const positionPct = planetData.pos; const labelText = planetData.label || 'N/A'; const visualHeightPct = planetData.visH || MIN_PLANET_VISUAL_HEIGHT_PCT; const labelNudge = (index < 4 && isSunMode) ? -20 : 0;
                 const img = document.createElement('img'); img.src = `planets/${p}.png`; img.alt = p; img.className = 'dist-planet-img'; img.style.left = `${positionPct}%`; img.style.height = `${visualHeightPct}%`; if(distPlanetsContainer) distPlanetsContainer.appendChild(img);
                 const label = document.createElement('div'); label.className = 'dist-label'; label.style.left = `calc(${positionPct}% + ${labelNudge}px)`; label.textContent = labelText; if(distPlanetsContainer) distPlanetsContainer.appendChild(label);
             } else { console.warn(`[Draw Dist] Missing display data for planet '${p}' in mode '${currentDistMode}'. Skipping render.`); }
        });
         console.log("[Draw Dist] Finished drawing chart.");
    }

    // --- Custom Dropdown Logic ---
    function toggleCustomDropdown(forceClose = false) {
        if (!customDistDropdown || !customDistButton) return; // Safety check
        const shouldShow = !customDistDropdown.classList.contains('show') && !forceClose;
        customDistDropdown.classList.toggle('show', shouldShow);
        customDistButton.classList.toggle('open', shouldShow);

        if (shouldShow) {
            updateDropdownHighlight(); // Update highlight only when opening
        }
    }

    function updateDropdownHighlight() {
        if (!customDistList) return;
        customDistList.querySelectorAll('li').forEach(li => {
            li.classList.toggle('selected', li.dataset.planet === selectedCustomPlanet);
        });
    }

    function selectCustomPlanet(planetId) {
        console.log(`[Custom Select] Selected: ${planetId}`);
        selectedCustomPlanet = planetId;
        currentDistMode = 'custom'; // Set mode to custom

        // Update button text (Capitalize first letter)
        if (customDistButtonText) {
            customDistButtonText.textContent = planetId.charAt(0).toUpperCase() + planetId.slice(1);
        }

        // Update button active states
        document.querySelectorAll('#dist-mode-switch button').forEach(b => b.classList.remove('active'));
        if (customDistButton) customDistButton.classList.add('active');

        toggleCustomDropdown(true); // Close dropdown

        // Trigger redraw, which will handle the 'custom' mode placeholder/error state
        drawDistanceChart();
    }

    // Populate dropdown list initially
    function populateCustomDropdown() {
        if (!customDistList) return;
        customDistList.innerHTML = ''; // Clear existing
        CUSTOM_PLANET_OPTIONS.forEach(p => {
            const li = document.createElement('li');
            li.textContent = p.charAt(0).toUpperCase() + p.slice(1); // Capitalize
            li.dataset.planet = p; // Store planet ID
            customDistList.appendChild(li);
        });
    }

    // --- Event Handlers ---
    // Standard distance mode buttons
    document.querySelectorAll('#dist-mode-switch button[data-mode="distSun"], #dist-mode-switch button[data-mode="distEarth"]').forEach(button => {
        button.addEventListener('click', (event) => {
            const targetButton = event.currentTarget;
            if (!targetButton.disabled && !targetButton.classList.contains('active')) {
                const newMode = targetButton.dataset.mode;
                console.log(`[Event] Standard Distance mode changed to: ${newMode}`);
                currentDistMode = newMode;
                selectedCustomPlanet = null; // Reset custom selection
                if (customDistButtonText) customDistButtonText.textContent = 'custom'; // Reset custom button text

                // Update button styles
                document.querySelectorAll('#dist-mode-switch button').forEach(b => b.classList.remove('active'));
                targetButton.classList.add('active');

                toggleCustomDropdown(true); // Ensure dropdown is closed
                drawDistanceChart(); // Redraw with standard mode
            }
        });
    });

    // Custom distance button (toggle dropdown)
    if (customDistButton) {
        customDistButton.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent click from closing dropdown immediately
            console.log("[Event] Custom distance button clicked.");
            toggleCustomDropdown();
        });
    }

    // Custom distance list item selection
    if (customDistList) {
        customDistList.addEventListener('click', (event) => {
            if (event.target.tagName === 'LI' && event.target.dataset.planet) {
                event.stopPropagation();
                selectCustomPlanet(event.target.dataset.planet);
            }
        });
    }

    // Close dropdown if clicking outside
    document.addEventListener('click', (event) => {
        if (customDistDropdown && customDistDropdown.classList.contains('show')) {
            if (!customDistButton?.contains(event.target) && !customDistDropdown.contains(event.target)) {
                console.log("[Event] Click outside detected, closing dropdown.");
                toggleCustomDropdown(true); // Force close
            }
        }
    });

    // Size mode handler (unchanged)
    document.getElementById('size-mode-switch').addEventListener('click', (event) => { if (event.target.tagName === 'BUTTON' && !event.target.disabled && !event.target.classList.contains('active')) { const newMode = event.target.dataset.mode; console.log(`[Event] Size mode changed to: ${newMode}`); currentSizeMode = newMode; event.target.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); drawSizeGrid(); } });
    // Resize Listener (unchanged)
    let resizeTimeout; window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(() => { console.log("[Event] Debounced resize detected. Recalculating sizes & redrawing."); calculateTrueSizeData(); calculateApparentSunData(); if (liveApiData) { calculateApparentEarthData(liveApiData); calculateDistEarthData(liveApiData); } else { if(displayData.apparentEarth.requires_live) displayData.apparentEarth.status = 'pending'; if(displayData.distEarth.requires_live) displayData.distEarth.status = 'pending'; } drawSizeGrid(); drawDistanceChart(); }, 250); });

    // --- Initial Setup ---
    function initializeDashboard() {
        console.log("[Init] Initializing Dashboard...");
        // Check all required elements before proceeding
        if (!sizeGrid || !distAnchor || !distPlanetsContainer || !sizeLoading || !sizeError || !distLoading || !distError || !customDistButton || !customDistButtonText || !customDistDropdown || !customDistList) { console.error("[Init] FATAL: One or more essential DOM elements not found."); document.body.innerHTML = '<p style="color:red; padding: 50px; text-align: center;">Error: Essential page elements are missing.</p>'; return; }

        populateCustomDropdown(); // Add planets to the dropdown list
        calculateTrueSizeData(); calculateApparentSunData(); calculateDistSunData();
        sizeGrid.innerHTML = ''; PLANET_ORDER.forEach(p => { const slot = document.createElement('div'); slot.className = 'planet-slot'; slot.id = `slot-${p}`; slot.innerHTML = `<div class="planet-image-container"></div><div class="size-label" id="lbl-${p}"></div>`; sizeGrid.appendChild(slot); });

        fetchAndUpdateLiveData(); // Fetch data and trigger initial draws for live modes

        // Draw initial static views immediately if they are default
        if (!displayData[currentSizeMode]?.requires_live) { console.log("[Init] Drawing initial static Size Grid."); drawSizeGrid(); } else { showLoading('size', true); }
        if (!displayData[currentDistMode]?.requires_live) { console.log("[Init] Drawing initial static Distance Chart."); drawDistanceChart(); } else { showLoading('dist', true); }

        console.log("[Init] Dashboard Initialized.");
     }
    // --- Menu Toggle Placeholder --- (Unchanged)
    function toggleModal() { console.warn("[Event] toggleModal() called - implementation assumed elsewhere."); }
    // --- Start Initialization --- (Unchanged)
    document.addEventListener('DOMContentLoaded', initializeDashboard);

 </script>
 <script src="/scripts.js"></script> </body>
</html>
