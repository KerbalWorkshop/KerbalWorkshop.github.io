<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Planets Dashboard – Hansen Space</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700&family=Nunito+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/styles.css">
  <style>
    :root {
      --canvas:1200px;    /* grey strip max width */
      --side-pad:80px;    /* gutters */
      --grey:#2e2e2e;     /* strip bg */
      --cell:200px;       /* size grid cell base */
      --gap:50px;         /* grid gap base */
      --dist-aspect:1000/256; /* native distance ratio */

      /* distance visual sizing */
      --dist-planet-base-height-pct: 35%;
      --dist-planet-min-height-pct: 5%;
      --dist-planet-max-height-pct: 80%;
    }
    * { box-sizing:border-box; margin:0 }
    body {
      font-family:'Nunito Sans',sans-serif;
      background:#fff; color:#eee;
      overflow-x:hidden;
    }
    a { color:inherit; text-decoration:none }

    /* header */
    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:18px var(--side-pad); background:#fff; color:#111;
    }
    header nav ul {
      display:flex; gap:30px; list-style:none;
      font-weight:600; font-size:16px;
    }
    header .active { border-bottom:2px solid #111; padding-bottom:3px }
    .menu-icon { display:none; font-size:1.4rem; cursor:pointer }
    @media(max-width:850px){
      header nav { display:none }
      .menu-icon { display:block }
    }

    /* grey strip */
    #content { background:var(--grey); padding:0 var(--side-pad) }
    #inner   { max-width:var(--canvas); margin:0 auto; padding:30px 0 }

    /* intro */
    .intro-section {
      display:flex; justify-content:space-between; align-items:center;
      gap:40px; margin-bottom:60px;
    }
    .intro-title { font:700 40px/1 'Poppins'; color:#fff }
    .intro-text {
      max-width:640px; font-size:18px; line-height:1.6; color:#d0d0d0;
    }
    @media(max-width:850px){
      .intro-section{flex-direction:column;text-align:center}
      .intro-title{font-size:30px}
      .intro-text{font-size:15px}
    }

    /* shared */
    .dash-block{margin-bottom:70px}
    .block-title{font:600 28px/1 'Poppins';margin-bottom:24px;color:#fff}

    .pill-switch {
      display:flex; flex-wrap:wrap; justify-content:center; gap:5px;
      background:#555; border-radius:40px; padding:5px;
      width:fit-content; max-width:100%; margin:0 auto 40px;
      font-size:14px; position:relative;
    }
    .pill-switch button {
      padding:8px 15px; border:none; background:transparent;
      color:#eee; font-weight:600; cursor:pointer;
      border-radius:30px; flex-shrink:0;
    }
    .pill-switch button.active { background:#fff; color:#000 }
    .pill-switch button:disabled { color:#888; cursor:not-allowed }

    /* custom dropdown */
    .custom-select-container { position:relative }
    .custom-select-button .arrow { display:inline-block; width:0; height:0;
      border-left:5px solid transparent; border-right:5px solid transparent;
      border-top:5px solid currentColor; margin-left:8px; transition:transform .2s;}
    .custom-select-button.open .arrow { transform:rotate(180deg) }
    .custom-dropdown {
      display:none; position:absolute; top:calc(100% + 5px); left:50%;
      transform:translateX(-50%);
      background:#333; border:1px solid #666; border-radius:4px;
      padding:5px 0; z-index:20; min-width:150px; max-height:200px;
      overflow-y:auto; box-shadow:0 4px 8px rgba(0,0,0,0.3);
    }
    .custom-dropdown.show { display:block }
    .custom-dropdown ul { list-style:none; padding:0; margin:0 }
    .custom-dropdown li {
      padding:8px 15px; color:#eee; cursor:pointer; font-size:13px;
      white-space:nowrap;
    }
    .custom-dropdown li:hover { background:#555 }
    .custom-dropdown li.selected { background:#777; font-weight:bold }

    /* panels */
    .panel {
      background:#000; border-radius:6px;
      padding:48px 20px; margin-bottom:50px;
      position:relative; min-height:150px; overflow:hidden;
    }
    .loading-overlay, .error-overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,0.7); color:#eee; font-size:16px;
      z-index:10; padding:20px; pointer-events:none;
    }
    .error-overlay { color:#f88 }

    /* SIZE grid */
    #size-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(var(--cell),1fr));
      grid-auto-rows:var(--cell);
      gap:var(--gap);
      justify-content:center;
    }
    .planet-slot {
      position:relative; display:flex; flex-direction:column;
      justify-content:center; align-items:center;
    }
    .planet-image-container {
      flex-grow:1; display:flex; justify-content:center; align-items:center;
      width:100%; height:100%;
    }
    .planet-image-container img {
      max-height:100%; width:auto; object-fit:contain;
    }
    .size-label {
      position:absolute; bottom:-26px; left:50%;
      transform:translateX(-50%);
      font-size:14px; color:#eee; white-space:nowrap;
    }

    /* DISTANCE chart */
    .panel-distance { padding:48px 20px }
    #dist-box {
      width:80%; max-width:var(--canvas);
      margin:0 auto; aspect-ratio:var(--dist-aspect);
      position:relative; overflow:visible; min-height:150px;
    }
    .dist-track {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
    }
    .dist-track::before {
      content:""; position:absolute; top:50%; left:0;
      width:100%; height:2px; background:#666;
      transform:translateY(-50%);
    }
    .anchor, #dist-planets img {
      position:absolute; top:50%; transform:translate(-50%,-50%);
      width:auto; height:auto; max-height:none; z-index:5;
    }
    #dist-planets {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
    }
    .dist-label {
      position:absolute; top:calc(50% - 90px);
      color:#ddd; white-space:nowrap;
      transform-origin:top left; transform:rotate(-40deg);
      font-size:clamp(10px,1.2vw,14px); z-index:6;
    }

    .div { height:1px; background:#555; margin:50px 0 }
    footer {
      padding:20px var(--side-pad); background:#fff;
      text-align:center; font-size:14px; color:#999;
    }
    footer .social-links { margin-bottom:12px }
    footer .social-links img { height:24px; margin:0 10px }

    @media(max-width:850px){
      :root {
        --side-pad:20px;
        --cell:calc(200px*0.7);
        --gap:calc(50px*0.7);
        --dist-planet-base-height-pct:25%;
      }
      body{font-size:90%}
      .intro-title{font-size:26px}
      .intro-text{font-size:14px}
      .block-title{font-size:22px}
      .pill-switch{font-size:12px}
      .size-label,.dist-label{font-size:clamp(9px,1.3vw,12px)}
      header nav ul{font-size:14px}
      .pill-switch button{padding:6px 12px}
    }
  </style>
</head>
<body>

  <header>
    <a class="brand" href="/"><img src="/images/logo.png" alt="Hansen Space"></a>
    <nav>
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/myjourney.html">My Journey</a></li>
        <li><a href="/photography.html">Photography</a></li>
        <li><a href="/articles">Articles</a></li>
        <li><a href="/tools.html" class="active">Tools</a></li>
        <li><a href="/contact.html">Contact</a></li>
      </ul>
    </nav>
    <div class="menu-icon" onclick="toggleModal()">☰</div>
  </header>

  <div id="content">
    <div id="inner">

      <!-- intro -->
      <div class="intro-section">
        <h2 class="intro-title">PLANET DASHBOARD</h2>
        <p class="intro-text">A planetary dashboard for all of your needs.</p>
      </div>

      <!-- SIZE -->
      <section class="dash-block">
        <h3 class="block-title">SIZE</h3>
        <div class="pill-switch" id="size-mode-switch">
          <button data-mode="trueSize">true size</button>
          <button data-mode="apparentEarth" class="active">apparent size (from Earth)</button>
          <button data-mode="apparentSun">apparent size (from Sun)</button>
        </div>
        <div class="panel" id="size-panel">
          <div id="size-grid"></div>
          <div class="loading-overlay" id="size-loading" style="display:none;">Loading Size Data…</div>
          <div class="error-overlay"   id="size-error"   style="display:none;"></div>
        </div>
      </section>

      <!-- DISTANCE -->
      <section class="dash-block">
        <h3 class="block-title">DISTANCE</h3>
        <div class="pill-switch" id="dist-mode-switch">
          <button data-mode="distSun">from Sun</button>
          <button data-mode="distEarth" class="active">from Earth</button>
          <div class="custom-select-container">
            <button id="custom-dist-button" class="custom-select-button" data-mode="custom">
              <span id="custom-dist-button-text">custom</span>
              <span class="arrow"></span>
            </button>
            <div class="custom-dropdown" id="custom-dist-dropdown">
              <ul id="custom-dist-list"></ul>
            </div>
          </div>
        </div>
        <div class="panel panel-distance" id="dist-panel">
          <div id="dist-box">
            <div class="dist-track">
              <img id="dist-anchor" class="anchor" src="planets/earth.png" alt="anchor">
              <div id="dist-planets"></div>
            </div>
            <div class="loading-overlay" id="dist-loading" style="display:none;">Loading Distance Data…</div>
            <div class="error-overlay"   id="dist-error"   style="display:none;"></div>
          </div>
        </div>
      </section>

      <div class="div"></div>

      <section class="dash-block">
        <h3 class="block-title">IN THE SKY (coming soon)</h3>
        <p style="color:#ccc">Feature under construction.</p>
      </section>

    </div>
  </div>

  <footer>
    <div class="social-links">
      <a href="https://www.youtube.com/hansenspace"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube"></a>
      <a href="https://instagram.com/hansenspace"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram"></a>
      <a href="https://tiktok.com/@hansen_space"><img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok"></a>
    </div>
    <p>© <span id="year"></span> Hansen Space.</p>
    <script>document.getElementById('year').textContent=new Date().getFullYear();</script>
  </footer>

  <script>
    // --- Static Data ---
    const PLANET_META = {
      mercury:   4879,
      venus:    12104,
      earth:    12756,
      mars:      6779,
      jupiter: 139820,
      saturn:  108000,   // ← updated disc diameter
      uranus:   50724,
      neptune:  49244,
      sun:    1392700
    };
    const PLANET_SMA = {
      mercury:.387, venus:.723, earth:1, mars:1.524,
      jupiter:5.203, saturn:9.537, uranus:19.191, neptune:30.068
    };
    const CUSTOM_PLANET_OPTIONS = ["mercury","venus","mars","jupiter","saturn","uranus","neptune"];
    const AU_KM = 149597870.7;
    const REFRESH_INTERVAL_MS = 5*60*1000;

    // --- State & DOM ---
    let currentSizeMode='apparentEarth', currentDistMode='distEarth', selectedCustomPlanet=null;
    let liveApiData=null, apiRefreshTimer=null;
    const sizeGrid    = document.getElementById('size-grid');
    const distAnchor  = document.getElementById('dist-anchor');
    const distPlanets = document.getElementById('dist-planets');
    const customDistButton     = document.getElementById('custom-dist-button');
    const customDistButtonText = document.getElementById('custom-dist-button-text');
    const customDistDropdown   = document.getElementById('custom-dist-dropdown');
    const customDistList       = document.getElementById('custom-dist-list');

    // --- Helpers ---
    function toRadians(deg){ return deg*Math.PI/180; }
    function getCssCell(){ return parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell'))||200; }
    function getAngularSizeArcsec(diameterKm, distanceAu){
      const distKm = distanceAu*AU_KM;
      return 2*Math.atan((diameterKm/2)/distKm)*206264.806;
    }

    // --- Build SIZE grid slots ---
    PLANET_ORDER = ["mercury","venus","earth","mars","jupiter","saturn","uranus","neptune"];
    PLANET_ORDER.forEach(p=>{
      const slot=document.createElement('div');
      slot.className='planet-slot'; slot.id=`slot-${p}`;
      slot.innerHTML=`
        <div class="planet-image-container"></div>
        <div class="size-label" id="lbl-${p}"></div>`;
      sizeGrid.appendChild(slot);
    });

    // --- Populate custom dropdown ---
    function populateCustomDropdown(){
      customDistList.innerHTML='';
      CUSTOM_PLANET_OPTIONS.forEach(p=>{
        const li=document.createElement('li');
        li.textContent=p.charAt(0).toUpperCase()+p.slice(1);
        li.dataset.planet=p;
        customDistList.appendChild(li);
      });
    }
    // --- Toggle dropdown ---
    function toggleCustomDropdown(){
      customDistDropdown.classList.toggle('show');
      customDistButton.classList.toggle('open');
    }
    // --- Select custom planet ---
    function selectCustomPlanet(planetId){
      selectedCustomPlanet=planetId;
      currentDistMode='custom';
      const name = planetId.charAt(0).toUpperCase()+planetId.slice(1);
      customDistButtonText.textContent=`from ${name}`;
      document.querySelectorAll('#dist-mode-switch button').forEach(b=>b.classList.remove('active'));
      customDistButton.classList.add('active');
      toggleCustomDropdown();
      drawDistanceChart();
    }

    // --- Draw Size ---
    function drawSizeGrid(){
      const isTrue=(currentSizeMode==='trueSize');
      // compute data
      const data={};
      if(isTrue){
        const maxD=Math.max(...PLANET_ORDER.map(p=>PLANET_META[p]));
        PLANET_ORDER.forEach(p=>{
          const px=Math.max(4, PLANET_META[p]/maxD * getCssCell()*0.95);
          data[p]={px,label:`${PLANET_META[p].toLocaleString()} km`};
        });
      } else {
        // apparent Earth or Sun
        const key=currentSizeMode==='apparentSun'?'sun':'earth';
        const ar=[]; PLANET_ORDER.forEach(p=>{
          if(p==='earth'&&key==='earth')return;
          let arc=getAngularSizeArcsec(PLANET_META[p], PLANET_SMA[p]||liveApiData[p].distEarth);
          if(p==='saturn')arc*=1.1;
          ar.push(arc);
          data[p]={arc};
        });
        const maxArc=Math.max(...ar,1);
        PLANET_ORDER.forEach(p=>{
          if(p==='earth'&&key==='earth')return;
          const arc=(data[p].arc||0);
          const px=Math.max(4,arc/maxArc*getCssCell()*0.95);
          data[p]={px,label:`${arc.toFixed(1)}″`};
        });
      }
      // render
      sizeGrid.innerHTML='';
      const list = PLANET_ORDER.filter(p=>!(p==='earth'&&currentSizeMode==='apparentEarth'));
      list.forEach(p=>{
        const slot=document.createElement('div');
        slot.className='planet-slot';
        const imgC=document.createElement('div');
        imgC.className='planet-image-container';
        const img=document.createElement('img');
        img.src=`planets/${p}.png`; img.alt=p;
        img.style.height=`${data[p].px}px`; img.style.width='auto';
        imgC.appendChild(img);
        const lbl=document.createElement('div');
        lbl.className='size-label'; lbl.id=`lbl-${p}`;
        lbl.textContent=data[p].label;
        slot.appendChild(imgC);
        slot.appendChild(lbl);
        sizeGrid.appendChild(slot);
      });
    }

    // --- Draw Distance ---
    function drawDistanceChart(){
      if(!liveApiData) return;
      const box=document.getElementById('dist-box');
      const H=box.clientHeight;
      // anchor logic
      let anchorId = (currentDistMode==='distSun')?'sun':'earth';
      if(currentDistMode==='custom') anchorId=selectedCustomPlanet||'earth';
      distAnchor.src=`planets/${anchorId}.png`;
      if(currentDistMode==='distSun'){
        // true relative sun height
        const pct=(PLANET_META.sun/PLANET_META.jupiter)*parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dist-planet-base-height-pct'));
        distAnchor.style.height=`${pct}%`;
        distAnchor.style.transform='translate(0,-50%)'; // right edge at x=0
      } else {
        const pct=(PLANET_META[anchorId]/PLANET_META.jupiter)*parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--dist-planet-base-height-pct'));
        distAnchor.style.height=`${pct}%`;
        distAnchor.style.transform='translate(-50%,-50%)';
      }
      distAnchor.style.width='auto';
      distAnchor.style.display='block';

      // targets
      const set = (currentDistMode==='distSun')
                ? PLANET_ORDER
                : PLANET_ORDER.filter(p=>'earth'!==p);
      const dists = set.map(p=>
        currentDistMode==='distSun'
          ? PLANET_SMA[p]
          : liveApiData[p]?.distEarth||0
      );
      const maxD=Math.max(...dists,1);

      distPlanets.innerHTML='';
      set.forEach((p,i)=>{
        const dist=currentDistMode==='distSun'
                   ? PLANET_SMA[p]
                   : liveApiData[p]?.distEarth||0;
        const pct=dist/maxD*100;
        const vhp=(PLANET_META[p]/PLANET_META.jupiter)*35;
        const img=document.createElement('img');
        img.src=`planets/${p}.png`; img.alt=p;
        img.className='dist-planet-img';
        img.style.left=`${pct}%`;
        img.style.height=`${vhp}%`;
        img.style.width='auto';
        distPlanets.appendChild(img);

        const lbl=document.createElement('div');
        lbl.className='dist-label';
        lbl.style.left=`${pct}%`;
        lbl.textContent=`${dist.toFixed(3)} AU`;
        distPlanets.appendChild(lbl);
      });
    }

    // --- Fetch Live & Init ---
    async function fetchAndUpdateLiveData(){
      try {
        const res=await fetch('/.netlify/functions/planetDashboard');
        const json=await res.json();
        liveApiData={};
        json.data.table.rows.forEach(r=>{
          const id=r.entry.id.toLowerCase(),
                au=parseFloat(r.cells[0].distance.fromEarth.au),
                ra=toRadians(parseFloat(r.cells[0].position.equatorial.rightAscension.hours)*15),
                dec=toRadians(parseFloat(r.cells[0].position.equatorial.declination.degrees));
          liveApiData[id]={distEarth:au,raRad:ra,decRad:dec};
        });
        liveApiData.earth={distEarth:0,raRad:0,decRad:0};
      } catch(e){
        console.error("API fetch error",e);
      } finally {
        drawSizeGrid();
        drawDistanceChart();
        clearTimeout(apiRefreshTimer);
        apiRefreshTimer=setTimeout(fetchAndUpdateLiveData,REFRESH_INTERVAL_MS);
      }
    }

    // --- Event Handlers ---
    document.querySelectorAll('#size-mode-switch button').forEach(b=>{
      b.onclick=()=>{
        if(b.classList.contains('active'))return;
        currentSizeMode=b.dataset.mode;
        b.parentNode.querySelectorAll('button')
         .forEach(x=>x.classList.toggle('active',x===b));
        drawSizeGrid();
      };
    });
    document.querySelectorAll('#dist-mode-switch button[data-mode^="dist"]').forEach(b=>{
      b.onclick=()=>{
        if(b.classList.contains('active'))return;
        currentDistMode=b.dataset.mode;
        b.parentNode.querySelectorAll('button')
         .forEach(x=>x.classList.toggle('active',x===b));
        drawDistanceChart();
      };
    });
    customDistButton.addEventListener('click', e=>{
      e.stopPropagation(); toggleCustomDropdown();
    });
    customDistList.addEventListener('click', e=>{
      if(e.target.tagName==='LI') {
        e.stopPropagation();
        selectCustomPlanet(e.target.dataset.planet);
      }
    });
    document.addEventListener('click', e=>{
      if(customDistDropdown.classList.contains('show')
         && !customDistButton.contains(e.target)
         && !customDistDropdown.contains(e.target)) {
        toggleCustomDropdown();
      }
    });

    function toggleModal(){ /* existing nav modal logic */ }

    document.addEventListener('DOMContentLoaded', ()=>{
      populateCustomDropdown();
      fetchAndUpdateLiveData();
      window.addEventListener('resize', ()=>{
        drawSizeGrid();
        drawDistanceChart();
      });
    });
  </script>
  <script src="/scripts.js"></script>
</body>
</html>
