<!-- File: tools/plane-moon-transit.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>üõ©Ô∏èüåï Transit Debug</title>
  <style>
    body { font-family: sans-serif; padding:1rem; }
    label { display:block; margin:0.5rem 0; }
    button { margin:0.5rem 0; }
    pre { background:#eee; padding:1rem; max-height:50vh; overflow:auto; }
  </style>
</head>
<body>
  <h1>Debug: Moon‚ÄìPlane Transit</h1>

  <label>
    Time Zone:
    <input id="timezone" readonly>
    <button id="tzDetect">Detect TZ</button>
  </label>

  <label>
    Lat: <input id="lat" type="number" step="0.0001" value="0">
    Lon: <input id="lon" type="number" step="0.0001" value="0">
    <button id="locBtn">Use My Location</button>
  </label>

  <label>Start (local): <input id="start" type="datetime-local"></label>
  <label>End   (local): <input id="end"   type="datetime-local"></label>
  <label>Radius (km):   <input id="radius" type="number" value="50"></label>
  <button id="run">Run Debug</button>

  <pre id="output">Console logs will appear here‚Ä¶</pre>

  <script>
    const out = document.getElementById("output");
    function log(...args) {
      console.log(...args);
      out.textContent += args.map(a=>typeof a==="object"?JSON.stringify(a,null,2):a).join(" ") + "\n";
    }
    function error(...args) {
      console.error(...args);
      out.textContent += "[ERROR] " + args.join(" ") + "\n";
    }

    // TZ
    const detect = () => { 
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      document.getElementById("timezone").value = tz;
      log("Detected TZ:", tz);
    };
    detect();
    document.getElementById("tzDetect").onclick = detect;

    // geoloc
    document.getElementById("locBtn").onclick = () => {
      navigator.geolocation.getCurrentPosition(
        pos => {
          log("Geolocation success:", pos.coords);
          document.getElementById("lat").value = pos.coords.latitude;
          document.getElementById("lon").value = pos.coords.longitude;
        },
        err => error("Geolocation error:", err.message)
      );
    };

    // main
    document.getElementById("run").onclick = async () => {
      out.textContent = ""; 
      try {
        const lat    = parseFloat(document.getElementById("lat").value);
        const lon    = parseFloat(document.getElementById("lon").value);
        const startL = document.getElementById("start").value;
        const endL   = document.getElementById("end").value;
        const radius = parseFloat(document.getElementById("radius").value);
        log("Inputs ‚Üí", { lat, lon, startL, endL, radius });

        if (isNaN(lat)||isNaN(lon)||!startL||!endL) {
          throw new Error("Missing inputs");
        }

        const startISO = new Date(startL).toISOString();
        const endISO   = new Date(endL).toISOString();
        log("Converted to ISO UTC ‚Üí", { startISO, endISO });

        // 1) Moon
        const moonUrl = `/.netlify/functions/getMoonPositions`
                      + `?lat=${lat}&lon=${lon}`
                      + `&start=${encodeURIComponent(startISO)}`
                      + `&end=${encodeURIComponent(endISO)}`
                      + `&step=15`;
        log("Fetching Moon URL:", moonUrl);
        const mRes = await fetch(moonUrl);
        log("Moon fetch status:", mRes.status);
        const moonData = await mRes.json();
        log(`Moon data samples: ${moonData.length}`, moonData.slice(0,3));

        // 2) Flights
        const flightUrl = `/.netlify/functions/getFlightPaths`
                        + `?lat=${lat}&lon=${lon}`
                        + `&start=${encodeURIComponent(startISO)}`
                        + `&end=${encodeURIComponent(endISO)}`
                        + `&step=15&radiusKm=${radius}`;
        log("Fetching Flight URL:", flightUrl);
        const fRes = await fetch(flightUrl);
        log("Flight fetch status:", fRes.status);
        const { flights } = await fRes.json();
        log(`Flights fetched: ${flights.length}`, flights.slice(0,3));

        // 3) Cross-check
        const matches = [];
        moonData.forEach(m => {
          if (m.error) { error("Moon error at", m.time, m.error); return; }
          flights.forEach(f => {
            const p = f.positions.find(x => x.time === m.time);
            if (p) {
              log(`Possible at ${m.time}`, { flight: f.id, moonAz:m.az, moonAlt:m.alt, planeLat:p.latitude, planeLon:p.longitude });
              matches.push({ time:m.time, flight:f.id });
            }
          });
        });
        log("Total matches:", matches.length, matches);
      } catch (e) {
        error("Run error:", e.message);
      }
    };
  </script>
</body>
</html>
